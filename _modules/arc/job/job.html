

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>arc.job.job &mdash; ARC 1.1.0 Documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> ARC
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../running.html">Running ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced.html">Advanced Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">ARCâ€™s API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools.html">Standalone tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cite.html">How to cite ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../licence.html">Licence</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ARC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>arc.job.job</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for arc.job.job</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># encoding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The ARC Job module</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">arc.common</span> <span class="k">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">arc.settings</span> <span class="k">import</span> <span class="n">arc_path</span><span class="p">,</span> <span class="n">servers</span><span class="p">,</span> <span class="n">submit_filename</span><span class="p">,</span> <span class="n">delete_command</span><span class="p">,</span> <span class="n">t_max_format</span><span class="p">,</span>\
    <span class="n">input_filename</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">,</span> <span class="n">rotor_scan_resolution</span><span class="p">,</span> <span class="n">list_available_nodes_command</span><span class="p">,</span> <span class="n">levels_ess</span>
<span class="kn">from</span> <span class="nn">arc.job.submit</span> <span class="k">import</span> <span class="n">submit_scripts</span>
<span class="kn">from</span> <span class="nn">arc.job.inputs</span> <span class="k">import</span> <span class="n">input_files</span>
<span class="kn">from</span> <span class="nn">arc.job.ssh</span> <span class="k">import</span> <span class="n">SSHClient</span>
<span class="kn">from</span> <span class="nn">arc.job.local</span> <span class="k">import</span> <span class="n">get_last_modified_time</span><span class="p">,</span> <span class="n">submit_job</span><span class="p">,</span> <span class="n">delete_job</span><span class="p">,</span> <span class="n">execute_command</span><span class="p">,</span> <span class="n">check_job_status</span><span class="p">,</span>\
    <span class="n">rename_output</span>
<span class="kn">from</span> <span class="nn">arc.arc_exceptions</span> <span class="k">import</span> <span class="n">JobError</span><span class="p">,</span> <span class="n">SpeciesError</span>

<span class="c1">##################################################################</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>


<div class="viewcode-block" id="Job"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job">[docs]</a><span class="k">class</span> <span class="nc">Job</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ARC&#39;s Job class.</span>

<span class="sd">    Args:</span>
<span class="sd">        project (str): The project&#39;s name. Used for naming the directory.</span>
<span class="sd">        project_directory (str): The path to the project directory.</span>
<span class="sd">        ess_settings (dict): A dictionary of available ESS and a corresponding server list.</span>
<span class="sd">        species_name (str): The species/TS name. Used for naming the directory.</span>
<span class="sd">        xyz (str): The xyz geometry. Used for the calculation.</span>
<span class="sd">        job_type (str): The job&#39;s type.</span>
<span class="sd">        level_of_theory (str): Level of theory, e.g. &#39;CBS-QB3&#39;, &#39;CCSD(T)-F12a/aug-cc-pVTZ&#39;, &#39;B3LYP/6-311++G(3df,3pd)&#39;...</span>
<span class="sd">        multiplicity (int): The species multiplicity.</span>
<span class="sd">        charge (int, optional): The species net charge. Default is 0.</span>
<span class="sd">        conformer (int, optional): Conformer number if optimizing conformers.</span>
<span class="sd">        fine (bool, optional): Whether to use fine geometry optimization parameters.</span>
<span class="sd">        shift (str, optional): A string representation alpha- and beta-spin orbitals shifts (molpro only).</span>
<span class="sd">        software (str, optional): The electronic structure software to be used.</span>
<span class="sd">        is_ts (bool, optional): Whether this species represents a transition structure.</span>
<span class="sd">        scan (list, optional): A list representing atom labels for the dihedral scan</span>
<span class="sd">                              (e.g., &quot;2 1 3 5&quot; as a string or [2, 1, 3, 5] as a list of integers).</span>
<span class="sd">        pivots (list, optional): The rotor scan pivots, if the job type is scan. Not used directly in these methods,</span>
<span class="sd">                                 but used to identify the rotor.</span>
<span class="sd">        memory (int, optional): The total job allocated memory in GB.</span>
<span class="sd">        comments (str, optional): Job comments (archived, not used).</span>
<span class="sd">        trsh (str, optional): A troubleshooting keyword to be used in input files.</span>
<span class="sd">        scan_trsh (str, optional): A troubleshooting method for rotor scans.</span>
<span class="sd">        ess_trsh_methods (list, optional): A list of troubleshooting methods already tried out for ESS convergence.</span>
<span class="sd">        bath_gas (str, optional): A bath gas. Currently used in OneDMin to calc L-J parameters.</span>
<span class="sd">                                  Allowed values are He, Ne, Ar, Kr, H2, N2, O2</span>
<span class="sd">        initial_trsh (dict, optional): Troubleshooting methods to try by default. Keys are ESS software,</span>
<span class="sd">                                       values are trshs.</span>
<span class="sd">        job_num (int, optional): Used as the entry number in the database, as well as the job name on the server.</span>
<span class="sd">        job_server_name (str, optional): Job&#39;s name on the server (e.g., &#39;a103&#39;).</span>
<span class="sd">        job_name (str, optional): Job&#39;s name for internal usage (e.g., &#39;opt_a103&#39;).</span>
<span class="sd">        job_id (int, optional): The job&#39;s ID determined by the server.</span>
<span class="sd">        server (str, optional): Server&#39;s name.</span>
<span class="sd">        initial_time (datetime, optional): The date-time this job was initiated.</span>
<span class="sd">        occ (int, optional): The number of occupied orbitals (core + val) from a molpro CCSD sp calc.</span>
<span class="sd">        max_job_time (int, optional): The maximal allowed job time on the server in hours.</span>
<span class="sd">        scan_res (int, optional): The rotor scan resolution in degrees.</span>
<span class="sd">        checkfile (str, optional): The path to a previous Gaussian checkfile to be used in the current job.</span>
<span class="sd">        number_of_radicals (int, optional): The number of radicals (inputted by the user, ARC won&#39;t attempt to</span>
<span class="sd">                                            determine it). Defaults to None. Important, e.g., if a Species is a bi-rad</span>
<span class="sd">                                            singlet, in which case the job should be unrestricted with</span>
<span class="sd">                                            multiplicity = 1.</span>
<span class="sd">        conformers (str, optional): A path to the YAML file conformer coordinates for a Gromacs MD job.</span>
<span class="sd">        radius (float, optional): The species radius in Angstrom.</span>
<span class="sd">        testing (bool, optional): Whether the object is generated for testing purposes, True if it is.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        project (str): The project&#39;s name. Used for naming the directory.</span>
<span class="sd">        ess_settings (dict): A dictionary of available ESS and a corresponding server list.</span>
<span class="sd">        species_name (str): The species/TS name. Used for naming the directory.</span>
<span class="sd">        charge (int): The species net charge. Default is 0.</span>
<span class="sd">        multiplicity (int): The species multiplicity.</span>
<span class="sd">        number_of_radicals (int): The number of radicals (inputted by the user, ARC won&#39;t attempt to determine it).</span>
<span class="sd">                                  Defaults to None. Important, e.g., if a Species is a bi-rad singlet, in which case</span>
<span class="sd">                                  the job should be unrestricted with multiplicity = 1.</span>
<span class="sd">        spin (int): The spin. automatically derived from the multiplicity.</span>
<span class="sd">        xyz (str): The xyz geometry. Used for the calculation.</span>
<span class="sd">        radius (float): The species radius in Angstrom.</span>
<span class="sd">        n_atoms (int): The number of atoms in self.xyz.</span>
<span class="sd">        conformer (int): Conformer number if optimizing conformers.</span>
<span class="sd">        conformers (str): A path to the YAML file conformer coordinates for a Gromacs MD job.</span>
<span class="sd">        is_ts (bool): Whether this species represents a transition structure.</span>
<span class="sd">        level_of_theory (str): Level of theory, e.g. &#39;CBS-QB3&#39;, &#39;CCSD(T)-F12a/aug-cc-pVTZ&#39;, &#39;B3LYP/6-311++G(3df,3pd)&#39;...</span>
<span class="sd">        job_type (str): The job&#39;s type.</span>
<span class="sd">        scan (list): A list representing atom labels for the dihedral scan</span>
<span class="sd">                    (e.g., &quot;2 1 3 5&quot; as a string or [2, 1, 3, 5] as a list of integers).</span>
<span class="sd">        pivots (list): The rotor scan pivots, if the job type is scan. Not used directly in these methods,</span>
<span class="sd">                       but used to identify the rotor.</span>
<span class="sd">        scan_res (int): The rotor scan resolution in degrees.</span>
<span class="sd">        software (str): The electronic structure software to be used.</span>
<span class="sd">        server_nodes (list): A list of nodes this job was submitted to (for troubleshooting).</span>
<span class="sd">        memory_gb (int): The total job allocated memory in GB (14 by default).</span>
<span class="sd">        memory (int): The total job allocated memory in appropriate units per ESS.</span>
<span class="sd">        method (str): The calculation method (e.g., &#39;B3LYP&#39;, &#39;CCSD(T)&#39;, &#39;CBS-QB3&#39;...).</span>
<span class="sd">        basis_set (str): The basis set (e.g., &#39;6-311++G(d,p)&#39;, &#39;aug-cc-pVTZ&#39;...).</span>
<span class="sd">        fine (bool): Whether to use fine geometry optimization parameters.</span>
<span class="sd">        shift (str): A string representation alpha- and beta-spin orbitals shifts (molpro only).</span>
<span class="sd">        comments (str): Job comments (archived, not used).</span>
<span class="sd">        initial_time (datetime): The date-time this job was initiated.</span>
<span class="sd">        final_time (datetime): The date-time this job was initiated.</span>
<span class="sd">        run_time (timedelta): Job execution time.</span>
<span class="sd">        job_status (list): The job&#39;s server and ESS statuses.</span>
<span class="sd">                           The job server status is in job.job_status[0] and can be either &#39;initializing&#39; / &#39;running&#39;</span>
<span class="sd">                           / &#39;errored&#39; / &#39;done&#39;. The job ess (electronic structure software calculation) status is in</span>
<span class="sd">                           job.job_status[1] and can be either `initializing` / `running` / `errored:</span>
<span class="sd">                           {error type / message}` / `unconverged` / `done`.</span>
<span class="sd">        job_server_name (str): Job&#39;s name on the server (e.g., &#39;a103&#39;).</span>
<span class="sd">        job_name (str): Job&#39;s name for internal usage (e.g., &#39;opt_a103&#39;).</span>
<span class="sd">        job_id (int): The job&#39;s ID determined by the server.</span>
<span class="sd">        job_num (int): Used as the entry number in the database, as well as the job name on the server.</span>
<span class="sd">        local_path (str): Local path to job&#39;s folder.</span>
<span class="sd">        local_path_to_output_file (str): The local path to the output.out file.</span>
<span class="sd">        local_path_to_orbitals_file (str): The local path to the orbitals.fchk file (only for orbitals jobs).</span>
<span class="sd">        local_path_to_check_file (str): The local path to the Gaussian check file of the current job (downloaded).</span>
<span class="sd">        local_path_to_lj_file (str): The local path to the lennard_jones data file (from OneDMin).</span>
<span class="sd">        checkfile (str): The path to a previous Gaussian checkfile to be used in the current job.</span>
<span class="sd">        remote_path (str): Remote path to job&#39;s folder.</span>
<span class="sd">        submit (str): The submit script. Created automatically.</span>
<span class="sd">        input (str): The input file. Created automatically.</span>
<span class="sd">        server (str): Server&#39;s name.</span>
<span class="sd">        trsh (str): A troubleshooting keyword to be used in input files.</span>
<span class="sd">        ess_trsh_methods (list): A list of troubleshooting methods already tried out for ESS convergence.</span>
<span class="sd">        initial_trsh (dict): Troubleshooting methods to try by default. Keys are ESS software, values are trshs.</span>
<span class="sd">        scan_trsh (str): A troubleshooting method for rotor scans.</span>
<span class="sd">        occ (int): The number of occupied orbitals (core + val) from a molpro CCSD sp calc.</span>
<span class="sd">        project_directory (str): The path to the project directory.</span>
<span class="sd">        max_job_time (int): The maximal allowed job time on the server in hours.</span>
<span class="sd">        bath_gas (str): A bath gas. Currently used in OneDMin to calc L-J parameters.</span>
<span class="sd">                        Allowed values are He, Ne, Ar, Kr, H2, N2, O2</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">ess_settings</span><span class="p">,</span> <span class="n">species_name</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="p">,</span> <span class="n">multiplicity</span><span class="p">,</span>
                 <span class="n">project_directory</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_ts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">pivots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">scan_trsh</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bath_gas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">initial_trsh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job_num</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job_server_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">initial_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_job_time</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">scan_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">checkfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">number_of_radicals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">conformers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">testing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span> <span class="o">=</span> <span class="n">ess_settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">initial_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span> <span class="o">=</span> <span class="n">species_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_num</span> <span class="o">=</span> <span class="n">job_num</span> <span class="k">if</span> <span class="n">job_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charge</span> <span class="o">=</span> <span class="n">charge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">multiplicity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_radicals</span> <span class="o">=</span> <span class="n">number_of_radicals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span> <span class="o">=</span> <span class="n">conformer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformers</span> <span class="o">=</span> <span class="n">conformers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span> <span class="o">=</span> <span class="n">is_ts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ess_trsh_methods</span> <span class="o">=</span> <span class="n">ess_trsh_methods</span> <span class="k">if</span> <span class="n">ess_trsh_methods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trsh</span> <span class="o">=</span> <span class="n">trsh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_trsh</span> <span class="o">=</span> <span class="n">initial_trsh</span> <span class="k">if</span> <span class="n">initial_trsh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_trsh</span> <span class="o">=</span> <span class="n">scan_trsh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span> <span class="o">=</span> <span class="n">scan_res</span> <span class="k">if</span> <span class="n">scan_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rotor_scan_resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">scan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pivots</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> <span class="k">if</span> <span class="n">pivots</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pivots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">=</span> <span class="n">max_job_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="o">=</span> <span class="n">bath_gas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testing</span> <span class="o">=</span> <span class="n">testing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fine</span> <span class="o">=</span> <span class="n">fine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occ</span> <span class="o">=</span> <span class="n">occ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;initializing&#39;</span><span class="p">,</span> <span class="s1">&#39;initializing&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span> <span class="k">if</span> <span class="n">job_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">comments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span> <span class="o">=</span> <span class="n">project_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="n">checkfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">job_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;optfreq&#39;</span><span class="p">,</span> <span class="s1">&#39;sp&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">,</span> <span class="s1">&#39;scan&#39;</span><span class="p">,</span> <span class="s1">&#39;gsm&#39;</span><span class="p">,</span> <span class="s1">&#39;irc&#39;</span><span class="p">,</span> <span class="s1">&#39;ts_guess&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;orbitals&#39;</span><span class="p">,</span> <span class="s1">&#39;onedmin&#39;</span><span class="p">,</span> <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;gromacs&#39;</span><span class="p">]</span>  <span class="c1"># allowed job types</span>
        <span class="c1"># the &#39;conformer&#39; job type is identical to &#39;opt&#39;, but we differentiate them to be identifiable in Scheduler</span>
        <span class="k">if</span> <span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Job type </span><span class="si">{0}</span><span class="s2"> not understood. Must be one of the following:</span><span class="se">\n</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">job_type</span><span class="p">,</span> <span class="n">job_types</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="n">job_type</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;gromacs&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> Job of species </span><span class="si">{1}</span><span class="s1"> got None for xyz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformers</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;gromacs&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> Job of species </span><span class="si">{1}</span><span class="s1"> got None for conformers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_job_number</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_server_name</span> <span class="o">=</span> <span class="n">job_server_name</span> <span class="k">if</span> <span class="n">job_server_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;a&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_num</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span> <span class="o">=</span> <span class="n">job_name</span> <span class="k">if</span> <span class="n">job_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_server_name</span>

        <span class="c1"># determine level of theory and software to use:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_of_theory</span> <span class="o">=</span> <span class="n">level_of_theory</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="n">software</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">:</span>
            <span class="n">splits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_of_theory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># there are two &#39;/&#39; symbols in a ff_param_fit job&#39;s l.o.t, keep both</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is a composite job</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deduce_software</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span> <span class="k">if</span> <span class="n">server</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem_per_cpu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_gb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cpu_and_mem</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_file_paths</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">job_num</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># this checks job_num and not self.job_num on purpose</span>
            <span class="c1"># if job_num was given, then don&#39;t save as initiated jobs, this is a restarted job</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_initiated_job_to_csv_file</span><span class="p">()</span>

<div class="viewcode-block" id="Job.as_dict"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function for dumping this object as a dictionary in a YAML file for restarting ARC.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">job_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;initial_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;final_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;run_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_time</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;max_job_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;project_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;job_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_num</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;ess_trsh_methods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_trsh_methods</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;trsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;initial_trsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_trsh</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;job_server_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_server_name</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;level_of_theory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_of_theory</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_gb</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;software&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occ</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;job_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivots</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;scan_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span>
        <span class="n">job_dict</span><span class="p">[</span><span class="s1">&#39;scan_trsh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_trsh</span>
        <span class="k">return</span> <span class="n">job_dict</span></div>

    <span class="k">def</span> <span class="nf">_set_job_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used as the entry number in the database, as well as the job name on the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arc_path</span><span class="p">,</span> <span class="s1">&#39;initiated_jobs.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">csv_path</span><span class="p">):</span>
            <span class="c1"># check file, make index file and write headers if file doesn&#39;t exists</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;job_num&#39;</span><span class="p">,</span> <span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="s1">&#39;species_name&#39;</span><span class="p">,</span> <span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="s1">&#39;is_ts&#39;</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplicity&#39;</span><span class="p">,</span> <span class="s1">&#39;job_type&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;job_name&#39;</span><span class="p">,</span> <span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;software&#39;</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;basis_set&#39;</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span><span class="p">]</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">)</span>
            <span class="n">job_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">job_num</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">job_num</span> <span class="o">==</span> <span class="mi">100000</span><span class="p">:</span>
                    <span class="n">job_num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_num</span> <span class="o">=</span> <span class="n">job_num</span>

    <span class="k">def</span> <span class="nf">_write_initiated_job_to_csv_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write an initiated ARCJob into the initiated_jobs.csv file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arc_path</span><span class="p">,</span> <span class="s1">&#39;initiated_jobs.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># this is not a conformer search job</span>
            <span class="n">conformer</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conformer</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span> <span class="n">conformer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">]</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

<div class="viewcode-block" id="Job.write_completed_job_to_csv_file"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.write_completed_job_to_csv_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_completed_job_to_csv_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a completed ARCJob into the completed_jobs.csv file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="s1">&#39;done&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">determine_job_status</span><span class="p">()</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arc_path</span><span class="p">,</span> <span class="s1">&#39;completed_jobs.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">csv_path</span><span class="p">):</span>
            <span class="c1"># check file, make index file and write headers if file doesn&#39;t exists</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;job_num&#39;</span><span class="p">,</span> <span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="s1">&#39;species_name&#39;</span><span class="p">,</span> <span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="s1">&#39;is_ts&#39;</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="s1">&#39;multiplicity&#39;</span><span class="p">,</span> <span class="s1">&#39;job_type&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;job_name&#39;</span><span class="p">,</span> <span class="s1">&#39;job_id&#39;</span><span class="p">,</span> <span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="s1">&#39;software&#39;</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;basis_set&#39;</span><span class="p">,</span> <span class="s1">&#39;initial_time&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;final_time&#39;</span><span class="p">,</span> <span class="s1">&#39;run_time&#39;</span><span class="p">,</span> <span class="s1">&#39;job_status_(server)&#39;</span><span class="p">,</span> <span class="s1">&#39;job_status_(ESS)&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;ESS troubleshooting methods used&#39;</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span><span class="p">]</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">csv_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arc_path</span><span class="p">,</span> <span class="s1">&#39;completed_jobs.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># this is not a conformer search job</span>
            <span class="n">conformer</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conformer</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="s1">&#39;excel&#39;</span><span class="p">)</span>
            <span class="n">job_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                <span class="n">job_type</span> <span class="o">+=</span> <span class="s1">&#39; (fine)&#39;</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span> <span class="n">conformer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_time</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comments</span><span class="p">]</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span></div>

<div class="viewcode-block" id="Job.write_submit_script"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.write_submit_script">[docs]</a>    <span class="k">def</span> <span class="nf">write_submit_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write the Job&#39;s submit script.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">un</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;un&#39;</span><span class="p">]</span>  <span class="c1"># user name</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">&gt;</span> <span class="mi">9999</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Setting max_job_time to 120 hours&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">=</span> <span class="mi">120</span>
        <span class="k">if</span> <span class="n">t_max_format</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;days&#39;</span><span class="p">:</span>
            <span class="c1"># e.g., 5-0:00:00</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
            <span class="n">t_max</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">-</span><span class="si">{1}</span><span class="s1">:00:00&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t_max_format</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="s1">&#39;hours&#39;</span><span class="p">:</span>
            <span class="c1"># e.g., 120:00:00</span>
            <span class="n">t_max</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">:00:00&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not determine format for maximal job time.</span><span class="se">\n</span><span class="s1"> Format is determined by </span><span class="si">{0}</span><span class="s1">, but &#39;</span>
                           <span class="s1">&#39;got </span><span class="si">{1}</span><span class="s1"> for </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_max_format</span><span class="p">,</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">))</span>
        <span class="n">architecture</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pharos&#39;</span><span class="p">:</span>
            <span class="c1"># here we&#39;re hard-coding ARC for Pharos, a Green Group server</span>
            <span class="c1"># If your server has different node architectures, implement something similar</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">architecture</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#$ -l harpertown&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">architecture</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#$ -l magnycours&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">submit</span> <span class="o">=</span> <span class="n">submit_scripts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_server_name</span><span class="p">,</span> <span class="n">un</span><span class="o">=</span><span class="n">un</span><span class="p">,</span> <span class="n">t_max</span><span class="o">=</span><span class="n">t_max</span><span class="p">,</span> <span class="n">mem_per_cpu</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mem_per_cpu</span><span class="p">),</span> <span class="n">cpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">,</span>
                <span class="n">architecture</span><span class="o">=</span><span class="n">architecture</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">submit_scripts_for_printing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">server</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">submit_scripts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">submit_scripts_for_printing</span><span class="p">[</span><span class="n">server</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">software</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">submit_scripts_for_printing</span><span class="p">[</span><span class="n">server</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">software</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not find submit script for server </span><span class="si">{0}</span><span class="s1"> and software </span><span class="si">{1}</span><span class="s1">. Make sure your submit scripts &#39;</span>
                         <span class="s1">&#39;(in arc/job/submit.py) are updated with the servers and software defined in arc/settings.py</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;Alternatively, It is possible that you defined parameters in curly braces (e.g., {{PARAM}}) &#39;</span>
                         <span class="s1">&#39;in your submit script/s. To avoid error, replace them with double curly braces (e.g., &#39;</span>
                         <span class="s1">&#39;{{{{PARAM}}}} instead of {{PARAM}}.</span><span class="se">\n</span><span class="s1">Identified the following submit scripts:</span><span class="se">\n</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">submit_scripts_for_printing</span><span class="p">))</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">submit_filename</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]]),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_upload_submit_file</span><span class="p">()</span></div>

<div class="viewcode-block" id="Job.write_input_file"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.write_input_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_input_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a software-specific, job-specific input file.</span>
<span class="sd">        Save the file locally and also upload it to the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_trsh</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh</span><span class="p">:</span>
            <span class="c1"># use the default trshs defined by the user in the initial_trsh dictionary</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_trsh</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trsh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_trsh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">slash</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">and</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">:</span>
            <span class="n">slash</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_radicals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># don&#39;t add &#39;u&#39; to composite jobs. Do add &#39;u&#39; for bi-rad singlets if `number_of_radicals` &gt; 1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_radicals</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using an unrestricted method for species </span><span class="si">{0}</span><span class="s1"> which has </span><span class="si">{1}</span><span class="s1"> radicals and &#39;</span>
                            <span class="s1">&#39;multiplicity </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">number_of_radicals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="n">restricted</span> <span class="o">=</span> <span class="s1">&#39;True&#39;</span>  <span class="c1"># In QChem this attribute is &quot;unrestricted&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">restricted</span> <span class="o">=</span> <span class="s1">&#39;u&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="n">restricted</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>  <span class="c1"># In QChem this attribute is &quot;unrestricted&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">restricted</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">job_type_1</span><span class="p">,</span> <span class="n">job_type_2</span><span class="p">,</span> <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># &#39;vdz&#39; troubleshooting in molpro:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh</span> <span class="o">==</span> <span class="s1">&#39;vdz&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;***,name</span>
<span class="s2">memory,</span><span class="si">{memory}</span><span class="s2">,m;</span>
<span class="s2">geometry={{angstrom;</span>
<span class="si">{xyz}</span><span class="s2"></span>
<span class="s2">}}</span>

<span class="s2">basis=cc-pVDZ</span>
<span class="s2">int;</span>
<span class="s2">{{hf;wf,spin=</span><span class="si">{spin}</span><span class="s2">,charge=</span><span class="si">{charge}</span><span class="s2">;}}</span>
<span class="si">{restricted}{method}</span><span class="s2">;</span>

<span class="s2">basis=</span><span class="si">{basis}</span><span class="s2"></span>
<span class="s2">int;</span>
<span class="s2">{{hf;</span><span class="si">{shift}</span><span class="s2"></span>
<span class="s2">maxit,1000;</span>
<span class="s2">wf,spin=</span><span class="si">{spin}</span><span class="s2">,charge=</span><span class="si">{charge}</span><span class="s2">;}}</span>

<span class="si">{restricted}{method}</span><span class="s2">;</span>
<span class="si">{job_type_1}</span><span class="s2"></span>
<span class="si">{job_type_2}</span><span class="s2"></span>
<span class="s2">---;&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(ts, calcfc, noeigentest, maxstep=5)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="c1"># Note that the Acc2E argument is not available in Gaussian03</span>
                    <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;scf=(tight, direct) integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(ts, calcfc, noeigentest, tight, maxstep=5)&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(tight)&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;ts&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   GEOM_OPT_TOL_GRADIENT 15</span><span class="se">\n</span><span class="s1">   GEOM_OPT_TOL_DISPLACEMENT 60</span><span class="se">\n</span><span class="s1">   GEOM_OPT_TOL_ENERGY 5&#39;</span>
                    <span class="k">if</span> <span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">:</span>
                        <span class="c1"># Try to capture DFT levels (containing the letter &#39;b&#39;?), and det a fine DFT grid</span>
                        <span class="c1"># See 4.4.5.2 Standard Quadrature Grids, S in</span>
                        <span class="c1"># http://www.q-chem.com/qchem-website/manual/qchem50_manual/sect-DFT.html</span>
                        <span class="n">fine</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   XC_GRID 3&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">optg, root=2, method=qsd, readhess, savexyz=&#39;geometry.xyz&#39;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">optg, savexyz=&#39;geometry.xyz&#39;&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;orbitals&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;ts&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;PRINT_ORBITALS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trsh</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   NBO           TRUE</span><span class="se">\n</span><span class="s1">   RUN_NBO6      TRUE</span><span class="se">\n</span><span class="s1">   &#39;</span> \
                             <span class="s1">&#39;PRINT_ORBITALS  TRUE</span><span class="se">\n</span><span class="s1">   GUI           2&#39;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;ff_param_fit&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="n">job_type_1</span><span class="p">,</span> <span class="n">job_type_2</span> <span class="o">=</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">--Link1--</span>
<span class="si">%c</span><span class="s2">hk=check.chk</span>
<span class="s2">%mem=</span><span class="si">{memory}</span><span class="s2">mb</span>
<span class="s2">%NProcShared=</span><span class="si">{cpus}</span><span class="s2"></span>

<span class="s2"># HF/6-31G(d) SCF=Tight Pop=MK IOp(6/33=2,6/41=10,6/42=17) scf(maxcyc=500) guess=read geom=check Maxdisk=2GB</span>

<span class="s2">name</span>

<span class="si">{charge}</span><span class="s2"> </span><span class="si">{multiplicity}</span><span class="s2"></span>


<span class="s2">&quot;&quot;&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;freq&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="n">job_type_2</span> <span class="o">=</span> <span class="s1">&#39;freq iop(7/33=1) scf=(tight, direct) integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;freq&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{frequencies;</span><span class="se">\n</span><span class="s1">thermo;</span><span class="se">\n</span><span class="s1">print,HESSIAN,thermo;}&#39;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;optfreq&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(ts, calcfc, noeigentest, maxstep=5)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(calcfc, noeigentest)&#39;</span>
                <span class="n">job_type_2</span> <span class="o">=</span> <span class="s1">&#39;freq iop(7/33=1)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;scf=(tight, direct) integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(ts, calcfc, noeigentest, tight, maxstep=5)&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(calcfc, noeigentest, tight)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;@@@</span>

<span class="s2">$molecule</span>
<span class="s2">   read</span>
<span class="s2">$end</span>

<span class="s2">$rem</span>
<span class="s2">   JOBTYPE       </span><span class="si">{job_type_2}</span><span class="s2"></span>
<span class="s2">   METHOD        </span><span class="si">{method}</span><span class="s2"></span>
<span class="s2">   UNRESTRICTED  </span><span class="si">{restricted}</span><span class="s2"></span>
<span class="s2">   BASIS         </span><span class="si">{basis}</span><span class="s2"></span>
<span class="s2">   SCF_GUESS     read</span>
<span class="s2">$end</span>

<span class="s2">&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;ts&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt&#39;</span>
                <span class="n">job_type_2</span> <span class="o">=</span> <span class="s1">&#39;freq&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   GEOM_OPT_TOL_GRADIENT 15</span><span class="se">\n</span><span class="s1">   GEOM_OPT_TOL_DISPLACEMENT 60</span><span class="se">\n</span><span class="s1">   GEOM_OPT_TOL_ENERGY 5&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">optg,root=2,method=qsd,readhess,savexyz=&#39;geometry.xyz&#39;&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">optg,savexyz=&#39;geometry.xyz&quot;</span>
                <span class="n">job_type_2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{frequencies;</span><span class="se">\n</span><span class="s1">thermo;</span><span class="se">\n</span><span class="s1">print,HESSIAN,thermo;}&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;sp&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;scf=(tight, direct) integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;sp&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;composite&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">fine</span> <span class="o">=</span> <span class="s1">&#39;scf=(tight, direct) integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(ts, calcfc, noeigentest, tight, maxstep=5)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_of_theory</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rocbs-qb3&#39;</span><span class="p">]:</span>
                        <span class="c1"># No analytic 2nd derivatives (FC) for these methods</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(noeigentest, tight)&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(calcfc, noeigentest, tight)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Currently composite methods are only supported in gaussian&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;scan&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(ts, modredundant, calcfc, noeigentest, maxStep=5) scf=(tight, direct)&#39;</span> \
                                 <span class="s1">&#39; integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">=</span> <span class="s1">&#39;opt=(modredundant, calcfc, noeigentest, maxStep=5) scf=(tight, direct)&#39;</span> \
                                 <span class="s1">&#39; integral=(grid=ultrafine, Acc2E=12)&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=read&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">job_type_1</span> <span class="o">+=</span> <span class="s1">&#39; guess=mix&#39;</span>
                <span class="n">scan_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">divmod</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Scan job got an illegal rotor scan resolution of </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span><span class="p">))</span>
                <span class="n">scan_string</span> <span class="o">=</span> <span class="s1">&#39;D &#39;</span> <span class="o">+</span> <span class="n">scan_string</span> <span class="o">+</span> <span class="s1">&#39;S &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">360</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>\
                              <span class="s1">&#39;</span><span class="si">{0:10}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Currently rotor scan is only supported in gaussian. Got: </span><span class="si">{0}</span><span class="s1"> using the </span><span class="si">{1}</span><span class="s1"> level of&#39;</span>
                                 <span class="s1">&#39; theory&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scan_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trsh</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ro&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;use=L506&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># xqc will do qc (quadratic convergence) if the job fails w/o it, so use by default</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;scf=xqc&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;irc&#39;</span><span class="p">:</span>  <span class="c1"># TODO</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;gsm&#39;</span><span class="p">:</span>  <span class="c1"># TODO</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="s1">&#39;mrci&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">!=</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Can only run MRCI on Molpro, not </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">occ</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Will not execute an MRCI calculation with more than 16 occupied orbitals.&#39;</span>
                               <span class="s1">&#39;Selective occ, closed, core, frozen keyword still not implemented.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_files</span><span class="p">[</span><span class="s1">&#39;mrci&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">,</span>
                                                            <span class="n">spin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trsh</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not interpret all input file keys in</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">))</span>
                    <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">memory</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">slash</span><span class="o">=</span><span class="n">slash</span><span class="p">,</span>
                                               <span class="n">basis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">cpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">,</span>
                                               <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="n">spin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span>
                                               <span class="n">job_type_1</span><span class="o">=</span><span class="n">job_type_1</span><span class="p">,</span> <span class="n">job_type_2</span><span class="o">=</span><span class="n">job_type_2</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="n">scan_string</span><span class="p">,</span>
                                               <span class="n">restricted</span><span class="o">=</span><span class="n">restricted</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">fine</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trsh</span><span class="p">,</span>
                                               <span class="n">scan_trsh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_trsh</span><span class="p">,</span> <span class="n">bath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span><span class="p">)</span> \
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not interpret all input file keys in</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">))</span>
                <span class="k">raise</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">input_filename</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_upload_input_file</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">get_last_modified_time</span><span class="p">(</span>
                    <span class="n">file_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">submit_filename</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]]))</span>
                <span class="c1"># copy additional input files to local running directory</span>
                <span class="k">for</span> <span class="n">up_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span>
                        <span class="n">source_path</span> <span class="o">=</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]</span>
                        <span class="n">destination_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;input_files&#39;</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_files</span><span class="p">[</span><span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]]))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_upload_check_file</span><span class="p">(</span><span class="n">local_check_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">checkfile</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_upload_submit_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
        <span class="n">ssh</span><span class="o">.</span><span class="n">send_command_to_server</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;mkdir -p </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">))</span>
        <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">submit_filename</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]])</span>
        <span class="n">ssh</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">file_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_upload_input_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
        <span class="n">ssh</span><span class="o">.</span><span class="n">send_command_to_server</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;mkdir -p </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">input_filename</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">])</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">file_string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">up_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span>
                <span class="n">local_file_path</span> <span class="o">=</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;input_files&#39;</span><span class="p">:</span>
                <span class="n">local_file_path</span> <span class="o">=</span> <span class="n">input_files</span><span class="p">[</span><span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;local&#39;</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Unclear file source for </span><span class="si">{0}</span><span class="s1">. Should either be &quot;path&quot; of &quot;input_files&quot;, &#39;</span>
                               <span class="s1">&#39;got: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]))</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;remote&#39;</span><span class="p">],</span> <span class="n">local_file_path</span><span class="o">=</span><span class="n">local_file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;make_x&#39;</span><span class="p">]:</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">send_command_to_server</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;chmod +x </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">up_file</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]),</span> <span class="n">remote_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">get_last_modified_time</span><span class="p">(</span>
            <span class="n">remote_file_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">submit_filename</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]]))</span>

    <span class="k">def</span> <span class="nf">_upload_check_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_check_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
            <span class="n">remote_check_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span>
            <span class="n">local_check_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">remote_check_file_path</span> <span class="ow">is</span> <span class="kc">None</span>\
                <span class="k">else</span> <span class="n">local_check_file_path</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_check_file_path</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="n">ssh</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_check_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="n">local_check_file_path</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;uploading checkpoint file for </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># running locally, just copy the check file to the job folder</span>
            <span class="n">new_check_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">local_check_file_path</span><span class="p">,</span> <span class="n">new_check_file_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_download_output_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download ESS output, orbitals check file, and the Gaussian check file, if relevant.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>

        <span class="c1"># download output file</span>
        <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">])</span>
        <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;output file for </span><span class="si">{0}</span><span class="s1"> was not downloaded properly&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">get_last_modified_time</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">)</span>

        <span class="c1"># download orbitals FChk file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;orbitals&#39;</span><span class="p">:</span>
            <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;input.FChk&#39;</span><span class="p">)</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Orbitals FChk file for </span><span class="si">{0}</span><span class="s1"> was not downloaded properly &#39;</span>
                               <span class="s1">&#39;(this is not the Gaussian formatted check file...)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>

        <span class="c1"># download Gaussian check file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="n">remote_check_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_check_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_check_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_check_file</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Gaussian check file for </span><span class="si">{0}</span><span class="s1"> was not downloaded properly&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>

        <span class="c1"># download Lennard_Jones data file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;onedmin&#39;</span><span class="p">:</span>
            <span class="n">remote_lj_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;lj.dat&#39;</span><span class="p">)</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_lj_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_lj_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_lj_file</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Lennard-Jones data file for </span><span class="si">{0}</span><span class="s1"> was not downloaded properly&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>

        <span class="c1"># download molpro log file (in addition to the output file)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
            <span class="n">remote_log_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;input.log&#39;</span><span class="p">)</span>
            <span class="n">local_log_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;output.log&#39;</span><span class="p">)</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_log_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="n">local_log_file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_log_file_path</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not download Molpro log file for </span><span class="si">{0}</span><span class="s1"> &#39;</span>
                               <span class="s1">&#39;(this is not the output file)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>

<div class="viewcode-block" id="Job.run"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the Job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running job </span><span class="si">{name}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> (fine opt)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span>
                                                                           <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pivots</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running job </span><span class="si">{name}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> (pivots: </span><span class="si">{pivots}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span>
                                                                                   <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span>
                                                                                   <span class="n">pivots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pivots</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running job </span><span class="si">{name}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;writing submit script...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_submit_script</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;writing input file...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_input_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;submitting job...&#39;</span><span class="p">)</span>
            <span class="c1"># submit_job returns job server status and job server id</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="n">remote_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># if the connection broke, the files might not have been uploaded correctly</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_submit_script</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_input_file</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="n">remote_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># running locally</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">submit_job</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Job.delete"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a running Job.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Deleting job </span><span class="si">{name}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;deleting job on </span><span class="si">{0}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">))</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;deleting job locally...&#39;</span><span class="p">)</span>
            <span class="n">delete_job</span><span class="p">(</span><span class="n">job_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Job.determine_job_status"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.determine_job_status">[docs]</a>    <span class="k">def</span> <span class="nf">determine_job_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the Job&#39;s status. Updates self.job_status.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;errored&#39;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">server_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_job_server_status</span><span class="p">()</span>
        <span class="n">ess_status</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">server_status</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ess_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_job_ess_status</span><span class="p">()</span>  <span class="c1"># also downloads output file</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got an IOError when trying to download output file for job </span><span class="si">{0}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
                <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_job_info</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Got the following information from the server:&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                        <span class="c1"># example:</span>
                        <span class="c1"># slurmstepd: *** JOB 7752164 CANCELLED AT 2019-03-27T00:30:50 DUE TO TIME LIMIT on node096 ***</span>
                        <span class="k">if</span> <span class="s1">&#39;cancelled&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;due to time limit&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Looks like the job was cancelled on </span><span class="si">{0}</span><span class="s1"> due to time limit. &#39;</span>
                                           <span class="s1">&#39;Got: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
                            <span class="n">new_max_job_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">-</span> <span class="mi">24</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">&gt;</span> <span class="mi">25</span> <span class="k">else</span> <span class="mi">1</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Setting max job time to </span><span class="si">{0}</span><span class="s1"> (was </span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_max_job_time</span><span class="p">,</span>
                                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">=</span> <span class="n">new_max_job_time</span>
                <span class="k">raise</span>
        <span class="k">elif</span> <span class="n">server_status</span> <span class="o">==</span> <span class="s1">&#39;running&#39;</span><span class="p">:</span>
            <span class="n">ess_status</span> <span class="o">=</span> <span class="s1">&#39;running&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span> <span class="o">=</span> <span class="p">[</span><span class="n">server_status</span><span class="p">,</span> <span class="n">ess_status</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_get_additional_job_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download the additional information of stdout and stderr from the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines1</span><span class="p">,</span> <span class="n">lines2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">cluster_soft</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cluster_soft</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;oge&#39;</span><span class="p">,</span> <span class="s1">&#39;sge&#39;</span><span class="p">]:</span>
            <span class="n">local_file_path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;out.txt&#39;</span><span class="p">)</span>
            <span class="n">local_file_path2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;err.txt&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
                <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;out.txt&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="n">local_file_path1</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Got the following error when trying to download out.txt for </span><span class="si">{0}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
                <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;err.txt&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="n">local_file_path2</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Got the following error when trying to download err.txt for </span><span class="si">{0}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file_path1</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_file_path1</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">lines1</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file_path2</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_file_path2</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">lines2</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines1</span><span class="p">])</span>
            <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">cluster_soft</span> <span class="o">==</span> <span class="s1">&#39;slurm&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">send_command_to_server</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s1">&#39;ls -alF&#39;</span><span class="p">,</span> <span class="n">remote_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">execute_command</span><span class="p">(</span><span class="s1">&#39;ls -alF </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">))</span>
            <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;slurm&#39;</span> <span class="ow">in</span> <span class="n">file_name</span> <span class="ow">and</span> <span class="s1">&#39;.out&#39;</span> <span class="ow">in</span> <span class="n">file_name</span><span class="p">:</span>
                    <span class="n">local_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                        <span class="n">remote_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ssh</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">remote_file_path</span><span class="p">,</span> <span class="n">local_file_path</span><span class="o">=</span><span class="n">local_file_path</span><span class="p">)</span>
                        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Got the following error when trying to download </span><span class="si">{0}</span><span class="s1"> for </span><span class="si">{1}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">):</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">lines1</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines1</span><span class="p">])</span>
                    <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">content</span>

    <span class="k">def</span> <span class="nf">_check_job_server_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Possible statuses: `initializing`, `running`, `errored on node xx`, `done`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ssh</span><span class="o">.</span><span class="n">check_job_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">check_job_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_job_ess_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the status of the job ran by the electronic structure software (ESS).</span>
<span class="sd">        Possible statuses: `initializing`, `running`, `errored: {error type / message}`, `unconverged`, `done`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_check_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_check_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_download_output_file</span><span class="p">()</span>  <span class="c1"># also downloads the Gaussian check file and orbital file if exist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If running locally, just rename the output file to &quot;output.out&quot; for consistency between software</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="o">=</span> <span class="n">get_last_modified_time</span><span class="p">(</span>
                    <span class="n">file_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="n">output_filename</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">]))</span>
            <span class="n">rename_output</span><span class="p">(</span><span class="n">local_file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">determine_run_time</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">20</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;Normal termination of Gaussian&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="s1">&#39;Error&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;NtrErr&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;Erroneous&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;malloc&#39;</span> <span class="ow">in</span> <span class="n">line</span> \
                                <span class="ow">or</span> <span class="s1">&#39;galloc&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                            <span class="k">if</span> <span class="s1">&#39;l9999.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;l103.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="k">return</span> <span class="s1">&#39;unconverged&#39;</span>
                            <span class="k">elif</span> <span class="s1">&#39;l502.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="k">return</span> <span class="s1">&#39;unconverged SCF&#39;</span>
                            <span class="k">elif</span> <span class="s1">&#39;l103.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="k">return</span> <span class="s1">&#39;l103 internal coordinate error&#39;</span>
                            <span class="k">elif</span> <span class="s1">&#39;Erroneous write&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;Write error in NtrExt1&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Ran out of disk space.&#39;</span>
                            <span class="k">elif</span> <span class="s1">&#39;l716.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Angle in z-matrix outside the allowed range 0 &lt; x &lt; 180.&#39;</span>
                            <span class="k">elif</span> <span class="s1">&#39;l301.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;l301&#39;</span>
                            <span class="k">elif</span> <span class="s1">&#39;NtrErr Called from FileIO&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Operation on .chk file was specified, but .chk was not found.&#39;</span>
                            <span class="k">elif</span> <span class="s1">&#39;l101.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Input Error. The blank line after the coordinate section is missing, &#39;</span> \
                                         <span class="s1">&#39;or charge/multiplicity was not specified correctly.&#39;</span>
                            <span class="k">elif</span> <span class="s1">&#39;l202.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;During the optimization process, either the standard orientation &#39;</span> \
                                         <span class="s1">&#39;or the point group of the molecule has changed.&#39;</span>
                            <span class="k">elif</span> <span class="s1">&#39;l401.exe&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;l401&#39;</span>
                            <span class="k">elif</span> <span class="s1">&#39;malloc failed&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;galloc&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Memory allocation failed (did you ask for too much?)&#39;</span>
                            <span class="k">elif</span> <span class="s1">&#39;A SYNTAX ERROR WAS DETECTED&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Check .inp carefully for syntax errors in keywords.&#39;</span>

                            <span class="k">if</span> <span class="n">reason</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;l301&#39;</span><span class="p">,</span> <span class="s1">&#39;l401&#39;</span><span class="p">]:</span>
                                <span class="n">additional_info</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;additional info: &#39;</span><span class="p">,</span> <span class="n">additional_info</span><span class="p">)</span>
                                <span class="k">if</span> <span class="s1">&#39;No data on chk file&#39;</span> <span class="ow">in</span> <span class="n">additional_info</span> \
                                        <span class="ow">or</span> <span class="s1">&#39;Basis set data is not on the checkpoint file&#39;</span> <span class="ow">in</span> <span class="n">additional_info</span><span class="p">:</span>
                                    <span class="n">reason</span> <span class="o">+=</span> <span class="s1">&#39; check file problematic&#39;</span>
                                <span class="k">elif</span> <span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;l301&#39;</span><span class="p">:</span>
                                    <span class="n">reason</span> <span class="o">+=</span> <span class="s1">&#39;Input Error. Either charge, multiplicity, or basis set was not &#39;</span> \
                                             <span class="s1">&#39;specified correctly. Or, an atom specified does not match any standard &#39;</span> \
                                              <span class="s1">&#39;atomic symbol.&#39;</span>
                                <span class="k">elif</span> <span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;l401&#39;</span><span class="p">:</span>
                                    <span class="n">reason</span> <span class="o">+=</span> <span class="s1">&#39; &quot;The projection from the old to the new basis set has failed.&quot;&#39;</span>

                            <span class="k">return</span> <span class="s1">&#39;errored: </span><span class="si">{0}</span><span class="s1">; </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s1">&#39;errored: Unknown reason&#39;</span>
                <span class="k">return</span> <span class="s1">&#39;done&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;Thank you very much for using Q-Chem&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="s1">&#39;SCF failed&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s1">&#39;errored: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;DIIS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># these are *normal* lines: &quot;SCF converges when DIIS error is below 1.0E-08&quot;, or</span>
                        <span class="c1"># &quot;Cycle       Energy         DIIS Error&quot;</span>
                        <span class="n">error_message</span> <span class="o">=</span> <span class="n">line</span>
                    <span class="k">elif</span> <span class="s1">&#39;Invalid charge/multiplicity combination&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="s1">&#39;The multiplicity and charge combination for species </span><span class="si">{0}</span><span class="s1"> are wrong.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">or</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">or</span> <span class="s1">&#39;ts&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;MAXIMUM OPTIMIZATION CYCLES REACHED&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="k">return</span> <span class="s1">&#39;errored: unconverged, max opt cycles reached&#39;</span>
                        <span class="k">elif</span> <span class="s1">&#39;OPTIMIZATION CONVERGED&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">done</span><span class="p">:</span>  <span class="c1"># `done` should already be assigned</span>
                            <span class="k">return</span> <span class="s1">&#39;done&#39;</span>
                <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;done&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">error_message</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s1">&#39;errored: &#39;</span> <span class="o">+</span> <span class="n">error_message</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s1">&#39;errored: Unknown reason&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;molpro calculation terminated&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>\
                            <span class="ow">or</span> <span class="s1">&#39;variable memory released&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="k">return</span> <span class="s1">&#39;done&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;No convergence&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s1">&#39;unconverged&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;A further&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;Mwords of memory are needed&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;Increase memory to&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># e.g.: `A further 246.03 Mwords of memory are needed for the triples to run.</span>
                        <span class="c1"># Increase memory to 996.31 Mwords.` (w/o the line break)</span>
                        <span class="k">return</span> <span class="s1">&#39;errored: additional memory (mW) required: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="s1">&#39;insufficient memory available - require&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="c1"># e.g.: `insufficient memory available - require              228765625  have</span>
                        <span class="c1">#        62928590</span>
                        <span class="c1">#        the request was for real words`</span>
                        <span class="c1"># add_mem = (float(line.split()[-2]) - float(prev_line.split()[0])) / 1e6</span>
                        <span class="k">return</span> <span class="s1">&#39;errored: additional memory (mW) required: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;the problem occurs&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s1">&#39;errored: &#39;</span> <span class="o">+</span> <span class="n">line</span>
                <span class="k">return</span> <span class="s1">&#39;errored: Unknown reason&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;onedmin&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_lj_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;LennardJones&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Epsilons[1/cm]&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;Sigmas[angstrom]&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="s1">&#39;End&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">score</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;done&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;errored: Unknown reason&#39;</span>

<div class="viewcode-block" id="Job.troubleshoot_server"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.troubleshoot_server">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshoot server errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;oge&#39;</span><span class="p">:</span>
            <span class="c1"># delete present server run</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Job </span><span class="si">{name}</span><span class="s1"> has server status &quot;</span><span class="si">{stat}</span><span class="s1">&quot; on </span><span class="si">{server}</span><span class="s1">. Troubleshooting by changing node.&#39;</span><span class="o">.</span>
                         <span class="nb">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">))</span>
            <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">send_command_to_server</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">delete_command</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]]</span> <span class="o">+</span>
                                       <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
            <span class="c1"># find available nodes</span>
            <span class="n">stdout</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">send_command_to_server</span><span class="p">(</span>
                <span class="n">command</span><span class="o">=</span><span class="n">list_available_nodes_command</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">:</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OGE&#39;</span> <span class="ow">and</span> <span class="s1">&#39;0/0/8&#39;</span> <span class="ow">in</span> <span class="n">line</span> \
                        <span class="ow">and</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_nodes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">server_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not find an available node on the server&#39;</span><span class="p">)</span>
                <span class="c1"># TODO: continue troubleshooting; if all else fails, put job to sleep</span>
                <span class="c1">#  and try again searching for a node</span>
                <span class="k">return</span>
            <span class="c1"># modify submit file</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">read_remote_file</span><span class="p">(</span><span class="n">remote_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span>
                                           <span class="n">filename</span><span class="o">=</span><span class="n">submit_filename</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;#$ -l h=node&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;#$ -l h=node</span><span class="si">{0}</span><span class="s1">.cluster&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">content</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;#$ -l h=node</span><span class="si">{0}</span><span class="s1">.cluster&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
            <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>  <span class="c1"># convert list into a single string, not to upset paramiko</span>
            <span class="c1"># resubmit</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">remote_file_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span>
                            <span class="n">submit_filename</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]]),</span> <span class="n">file_string</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;slurm&#39;</span><span class="p">:</span>
            <span class="c1"># TODO: change node on Slurm</span>
            <span class="c1"># delete present server run</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Job </span><span class="si">{name}</span><span class="s1"> has server status &quot;</span><span class="si">{stat}</span><span class="s1">&quot; on </span><span class="si">{server}</span><span class="s1">. Re-running job.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">))</span>
            <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">send_command_to_server</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">delete_command</span><span class="p">[</span><span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;cluster_soft&#39;</span><span class="p">]]</span> <span class="o">+</span>
                                       <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">))</span>
            <span class="c1"># resubmit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="Job.determine_run_time"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.determine_run_time">[docs]</a>    <span class="k">def</span> <span class="nf">determine_run_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the run time. Update self.run_time and round to seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_time</span>
            <span class="n">remainder</span> <span class="o">=</span> <span class="n">time_delta</span><span class="o">.</span><span class="n">microseconds</span> <span class="o">&gt;</span> <span class="mf">5e5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">time_delta</span><span class="o">.</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">remainder</span><span class="p">)</span></div>

<div class="viewcode-block" id="Job.deduce_software"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.deduce_software">[docs]</a>    <span class="k">def</span> <span class="nf">deduce_software</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deduce the software to be used based on heuristics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;onedmin&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;onedmin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the OneDMin software to compute Lennard-Jones parameters.</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="s1">&#39;ess_settings is:</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;onedmin&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Setting bath gas for Lennard-Jones calculation to N2 for species </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="o">=</span> <span class="s1">&#39;N2&#39;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;He&#39;</span><span class="p">,</span> <span class="s1">&#39;Ne&#39;</span><span class="p">,</span> <span class="s1">&#39;Ar&#39;</span><span class="p">,</span> <span class="s1">&#39;Kr&#39;</span><span class="p">,</span> <span class="s1">&#39;H2&#39;</span><span class="p">,</span> <span class="s1">&#39;N2&#39;</span><span class="p">,</span> <span class="s1">&#39;O2&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Bath gas for OneDMin should be one of the following:</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="s1">&#39;He, Ne, Ar, Kr, H2, N2, O2.</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;gromacs&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;gromacs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the Gromacs software to run the MD job </span><span class="si">{0}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="s1">&#39;ess_settings is:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gromacs&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;orbitals&#39;</span><span class="p">:</span>
            <span class="c1"># currently we only have a script to print orbitals on QChem,</span>
            <span class="c1"># could/should definitely be elaborated to additional ESS</span>
            <span class="k">if</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Could not find the QChem software to compute molecular orbitals.</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;ess_settings is:</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;composite&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the Gaussian software to run the composite method </span><span class="si">{0}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="s1">&#39;ess_settings is:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find Gaussian to fit force field parameters.</span><span class="se">\n</span><span class="s1">&#39;</span>
                               <span class="s1">&#39;ess_settings is:</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># First check the levels_ess dictionary from settings.py:</span>
            <span class="k">for</span> <span class="n">ess</span><span class="p">,</span> <span class="n">phrase_list</span> <span class="ow">in</span> <span class="n">levels_ess</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="n">phrase_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">phrase</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="n">ess</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;optfreq&#39;</span><span class="p">,</span> <span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;b2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">or</span> <span class="s1">&#39;dsd&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">or</span> <span class="s1">&#39;pw2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
                        <span class="c1"># this is a double-hybrid (MP2) DFT method, use Gaussian</span>
                        <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the Gaussian software to run the double-hybrid method </span><span class="si">{0}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">&#39;</span>
                                           <span class="s1">&#39;ess_settings is:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;ccs&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">or</span> <span class="s1">&#39;cis&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;molpro&#39;</span>
                        <span class="k">elif</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                        <span class="k">elif</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;b3lyp&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                        <span class="k">elif</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
                        <span class="k">elif</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;molpro&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;wb97xd&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the Gaussian software to run </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;wb97x-d3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the QChem software to run </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;b97&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">or</span> <span class="s1">&#39;def2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                        <span class="k">elif</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;m062x&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>  <span class="c1"># without dash</span>
                        <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the Gaussian software to run </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;m06-2x&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>  <span class="c1"># with dash</span>
                        <span class="k">if</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the QChem software to run </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;scan&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;wb97xd&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the Gaussian software to run </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;wb97x-d3&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the QChem software to run </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;b3lyp&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                        <span class="k">elif</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;b97&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">or</span> <span class="s1">&#39;def2&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                        <span class="k">elif</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;m06-2x&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>  <span class="c1"># with dash</span>
                        <span class="k">if</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the QChem software to run </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;m062x&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">:</span>  <span class="c1"># without dash</span>
                        <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the Gaussian software to run </span><span class="si">{0}</span><span class="s1">/</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                    <span class="k">elif</span> <span class="s1">&#39;pv&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;molpro&#39;</span>
                        <span class="k">elif</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                        <span class="k">elif</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gsm&#39;</span><span class="p">,</span> <span class="s1">&#39;irc&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="n">JobError</span><span class="p">(</span><span class="s1">&#39;Could not find the Gaussian software to run </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># if still no software was determined, just try by order, if exists</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;job_num: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_num</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;ess_trsh_methods: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;trsh: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trsh</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;job_type: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;job_name: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;level_of_theory: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;software: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;method: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;basis_set: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basis_set</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not determine software for job </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
                <span class="k">if</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to Gaussian&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;orca&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to Orca&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;orca&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to QChem&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;qchem&#39;</span>
                <span class="k">elif</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Setting it to Molpro&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s1">&#39;molpro&#39;</span></div>

<div class="viewcode-block" id="Job.set_cpu_and_mem"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.set_cpu_and_mem">[docs]</a>    <span class="k">def</span> <span class="nf">set_cpu_and_mem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memory</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the number of cpu&#39;s and the job&#39;s memory.</span>
<span class="sd">        self.memory is the actual memory allocated to the ESS.</span>
<span class="sd">        self.mem_per_cpu is the cluster software allocated memory.</span>
<span class="sd">        (self.mem_per_cpu should be slightly larger than self.memory when considering all cpus).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cpus&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>  <span class="c1"># set to 8 by default</span>
        <span class="n">max_mem</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># max memory per node</span>
        <span class="k">if</span> <span class="n">max_mem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">memory</span> <span class="o">&gt;</span> <span class="n">max_mem</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The memory for job </span><span class="si">{0}</span><span class="s1"> using </span><span class="si">{1}</span><span class="s1"> (</span><span class="si">{2}</span><span class="s1"> GB) exceeds 90</span><span class="si">% o</span><span class="s1">f the the maximum node memory on &#39;</span>
                           <span class="s1">&#39;</span><span class="si">{3}</span><span class="s1">. Setting it to 90% * </span><span class="si">{4}</span><span class="s1"> GB.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                                                                     <span class="n">memory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="n">max_mem</span><span class="p">))</span>
            <span class="n">memory</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">max_mem</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mem_per_cpu</span> <span class="o">=</span> <span class="n">memory</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mf">1.05</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mem_per_cpu</span> <span class="o">=</span> <span class="n">memory</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mf">1.1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span>  <span class="c1"># The `#SBATCH --mem-per-cpu` directive is in MB</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">memory_gb</span> <span class="o">=</span> <span class="n">memory</span>  <span class="c1"># store the memory in GB for troubleshooting (when re-running the job)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
            <span class="c1"># Molpro&#39;s memory is per cpu and in MW (mega word; 1 MW ~= 8 MB; 1 GB = 128 MW)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span> <span class="o">*</span> <span class="mi">128</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;terachem&#39;</span><span class="p">:</span>
            <span class="c1"># TeraChem&#39;s memory is per cpu and in MW (mega word; 1 MW ~= 8 MB; 1 GB = 128 MW)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span> <span class="o">*</span> <span class="mi">128</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="c1"># Gaussian&#39;s memory is in MB, total for all cpus</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;orca&#39;</span><span class="p">:</span>
            <span class="c1"># Orca&#39;s memory is per cpu and in MB</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
            <span class="c1"># QChem manages its memory automatically, for now ARC will not intervene</span>
            <span class="c1"># see http://www.q-chem.com/qchem-website/manual/qchem44_manual/CCparallel.html</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span>  <span class="c1"># dummy</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gromacs&#39;</span><span class="p">:</span>
            <span class="c1"># not managing memory for Gromacs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span>  <span class="c1"># dummy</span></div>

<div class="viewcode-block" id="Job.set_file_paths"><a class="viewcode-back" href="../../../api/job.html#arc.job.job.Job.set_file_paths">[docs]</a>    <span class="k">def</span> <span class="nf">set_file_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set local and remote job file paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conformer_folder</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformer</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer</span><span class="p">))</span>
        <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;TSs&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span> <span class="n">conformer_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;output.out&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;orbitals.fchk&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_lj_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;lj.dat&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_path_to_check_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span>

        <span class="c1"># parentheses don&#39;t play well in folder names:</span>
        <span class="n">species_name_for_remote_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;runs&#39;</span><span class="p">,</span> <span class="s1">&#39;ARC_Projects&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                        <span class="n">species_name_for_remote_path</span><span class="p">,</span> <span class="n">conformer_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># self.additional_files_to_upload is a list of dictionaries, each with the following keys:</span>
        <span class="c1"># &#39;name&#39;, &#39;source&#39;, &#39;local&#39;, and &#39;remote&#39;.</span>
        <span class="c1"># If &#39;source&#39; = &#39;path&#39;, then the value in &#39;local&#39; is treated as a file path.</span>
        <span class="c1"># If &#39;source&#39; = &#39;input_files&#39;, then the value in &#39;local&#39; will be taken from the respective entry in inputs.py</span>
        <span class="c1"># If &#39;make_x&#39; is True, the file will be made executable.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;onedmin&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;geo.xyz&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;geo&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;geo.xyz&#39;</span><span class="p">),</span>
                                                    <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;geo.xyz&#39;</span><span class="p">)})</span>
            <span class="c1"># make the m.x file executable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;m.x&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;input_files&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                                    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="s1">&#39;onedmin.molpro.x&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;m.x&#39;</span><span class="p">)})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;qc.mol&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;input_files&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="s1">&#39;onedmin.qc.mol&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;qc.mol&#39;</span><span class="p">)})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;gromacs&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;gaussian.out&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span>
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span> <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">,</span>
                                                                          <span class="s1">&#39;gaussian.out&#39;</span><span class="p">),</span>
                                                    <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;gaussian.out&#39;</span><span class="p">)})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;coords.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">conformers</span><span class="p">,</span>
                                                    <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;coords.yml&#39;</span><span class="p">)})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;acpype.py&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arc_path</span><span class="p">,</span> <span class="s1">&#39;arc&#39;</span><span class="p">,</span> <span class="s1">&#39;scripts&#39;</span><span class="p">,</span> <span class="s1">&#39;conformers&#39;</span><span class="p">,</span>
                                                                          <span class="s1">&#39;acpype.py&#39;</span><span class="p">),</span>
                                                    <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;acpype.py&#39;</span><span class="p">)})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;mdconf.py&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arc_path</span><span class="p">,</span> <span class="s1">&#39;arc&#39;</span><span class="p">,</span> <span class="s1">&#39;scripts&#39;</span><span class="p">,</span> <span class="s1">&#39;conformers&#39;</span><span class="p">,</span>
                                                                          <span class="s1">&#39;mdconf.py&#39;</span><span class="p">),</span>
                                                    <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;mdconf.py&#39;</span><span class="p">)})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;M00.tleap&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arc_path</span><span class="p">,</span> <span class="s1">&#39;arc&#39;</span><span class="p">,</span> <span class="s1">&#39;scripts&#39;</span><span class="p">,</span> <span class="s1">&#39;conformers&#39;</span><span class="p">,</span>
                                                                          <span class="s1">&#39;M00.tleap&#39;</span><span class="p">),</span>
                                                    <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;M00.tleap&#39;</span><span class="p">)})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additional_files_to_upload</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;mdp.mdp&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;make_x&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                    <span class="s1">&#39;local&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arc_path</span><span class="p">,</span> <span class="s1">&#39;arc&#39;</span><span class="p">,</span> <span class="s1">&#39;scripts&#39;</span><span class="p">,</span> <span class="s1">&#39;conformers&#39;</span><span class="p">,</span>
                                                                          <span class="s1">&#39;mdp.mdp&#39;</span><span class="p">),</span>
                                                    <span class="s1">&#39;remote&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remote_path</span><span class="p">,</span> <span class="s1">&#39;mdp.mdp&#39;</span><span class="p">)})</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2019, Alon Grinberg Dana

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>