

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>arc.scheduler &mdash; ARC 1.1.0 Documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ARC
          

          
          </a>

          
            
            
              <div class="version">
                1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running.html">Running ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced.html">Advanced Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../output.html">Output</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">ARCâ€™s API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">Standalone tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cite.html">How to cite ARC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../licence.html">Licence</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ARC</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>arc.scheduler</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for arc.scheduler</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># encoding: utf-8</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A module for scheduling jobs</span>
<span class="sd">Includes spawning, terminating, checking, and troubleshooting various jobs</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="k">import</span> <span class="n">display</span>

<span class="kn">import</span> <span class="nn">cclib</span>

<span class="kn">from</span> <span class="nn">arkane.statmech</span> <span class="k">import</span> <span class="n">determine_qm_software</span>
<span class="kn">from</span> <span class="nn">rmgpy.reaction</span> <span class="k">import</span> <span class="n">Reaction</span>
<span class="kn">from</span> <span class="nn">rmgpy.exceptions</span> <span class="k">import</span> <span class="n">InputError</span> <span class="k">as</span> <span class="n">RMGInputError</span>

<span class="kn">from</span> <span class="nn">arc.common</span> <span class="k">import</span> <span class="n">get_logger</span><span class="p">,</span> <span class="n">read_yaml_file</span><span class="p">,</span> <span class="n">save_yaml_file</span><span class="p">,</span> <span class="n">get_ordinal_indicator</span><span class="p">,</span> <span class="n">min_list</span>
<span class="kn">import</span> <span class="nn">arc.rmgdb</span> <span class="k">as</span> <span class="nn">rmgdb</span>
<span class="kn">from</span> <span class="nn">arc</span> <span class="k">import</span> <span class="n">plotter</span>
<span class="kn">from</span> <span class="nn">arc</span> <span class="k">import</span> <span class="n">parser</span>
<span class="kn">from</span> <span class="nn">arc.job.job</span> <span class="k">import</span> <span class="n">Job</span>
<span class="kn">from</span> <span class="nn">arc.arc_exceptions</span> <span class="k">import</span> <span class="n">SpeciesError</span><span class="p">,</span> <span class="n">SchedulerError</span><span class="p">,</span> <span class="n">TSError</span><span class="p">,</span> <span class="n">SanitizationError</span>
<span class="kn">from</span> <span class="nn">arc.job.ssh</span> <span class="k">import</span> <span class="n">SSHClient</span>
<span class="kn">from</span> <span class="nn">arc.job.local</span> <span class="k">import</span> <span class="n">check_running_jobs_ids</span>
<span class="kn">from</span> <span class="nn">arc.species.species</span> <span class="k">import</span> <span class="n">ARCSpecies</span><span class="p">,</span> <span class="n">TSGuess</span><span class="p">,</span> <span class="n">determine_rotor_symmetry</span>
<span class="kn">from</span> <span class="nn">arc.species.converter</span> <span class="k">import</span> <span class="n">get_xyz_string</span><span class="p">,</span> <span class="n">molecules_from_xyz</span><span class="p">,</span> <span class="n">check_isomorphism</span><span class="p">,</span> <span class="n">standardize_xyz_string</span>
<span class="kn">import</span> <span class="nn">arc.species.conformers</span> <span class="k">as</span> <span class="nn">conformers</span>
<span class="kn">from</span> <span class="nn">arc.ts.atst</span> <span class="k">import</span> <span class="n">autotst</span>
<span class="kn">from</span> <span class="nn">arc.settings</span> <span class="k">import</span> <span class="n">rotor_scan_resolution</span><span class="p">,</span> <span class="n">inconsistency_ab</span><span class="p">,</span> <span class="n">inconsistency_az</span><span class="p">,</span> <span class="n">maximum_barrier</span><span class="p">,</span> <span class="n">default_job_types</span><span class="p">,</span>\
    <span class="n">servers</span>

<span class="c1">##################################################################</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>


<div class="viewcode-block" id="Scheduler"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler">[docs]</a><span class="k">class</span> <span class="nc">Scheduler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ARC&#39;s Scheduler class. Creates jobs, submits, checks status, troubleshoots.</span>
<span class="sd">    Each species in `species_list` has to have a unique label.</span>

<span class="sd">    Dictionary structures::</span>

<span class="sd">        job_dict = {label_1: {&#39;conformers&#39;: {0: Job1,</span>
<span class="sd">                                             1: Job2, ...},  # TS guesses are considered `conformers` as well</span>
<span class="sd">                              &#39;opt&#39;:        {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &#39;sp&#39;:         {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &#39;freq&#39;:       {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &#39;composite&#39;:  {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              &#39;scan&#39;:       {job_name1: Job1,</span>
<span class="sd">                                             job_name2: Job2, ...},</span>
<span class="sd">                              ...</span>
<span class="sd">                              }</span>
<span class="sd">                    label_2: {...},</span>
<span class="sd">                    }</span>

<span class="sd">        output = {label_1: {&#39;status&#39;: ``str``,  # &#39;converged&#39;, or &#39;Error: &lt;reason&gt;&#39;</span>
<span class="sd">                            &#39;geo&#39;: &lt;path to geometry optimization output file&gt;,</span>
<span class="sd">                            &#39;freq&#39;: &lt;path to freq output file&gt;,</span>
<span class="sd">                            &#39;sp&#39;: &lt;path to sp output file&gt;,</span>
<span class="sd">                            &#39;composite&#39;: &lt;path to composite output file&gt;,</span>
<span class="sd">                 label_2: {...},</span>
<span class="sd">                 }</span>

<span class="sd">    Note: The rotor scan dicts are located under Species.rotors_dict</span>

<span class="sd">    Args:</span>
<span class="sd">        project (str): The project&#39;s name. Used for naming the working directory.</span>
<span class="sd">        ess_settings (dict): A dictionary of available ESS and a corresponding server list.</span>
<span class="sd">        species_list (list): Contains input :ref:`ARCSpecies &lt;species&gt;` objects (both species and TSs).</span>
<span class="sd">        rxn_list (list): Contains input :ref:`ARCReaction &lt;reaction&gt;` objects.</span>
<span class="sd">        project_directory (str): Folder path for the project: the input file path or ARC/Projects/project-name.</span>
<span class="sd">        composite_method (str, optional): A composite method to use.</span>
<span class="sd">        conformer_level (str, optional): The level of theory to use for conformer comparisons.</span>
<span class="sd">        opt_level (str, optional): The level of theory to use for geometry optimizations.</span>
<span class="sd">        freq_level (str, optional): The level of theory to use for frequency calculations.</span>
<span class="sd">        sp_level (str, optional): The level of theory to use for single point energy calculations.</span>
<span class="sd">        scan_level (str, optional): The level of theory to use for torsion scans.</span>
<span class="sd">        ts_guess_level (str, optional): The level of theory to use for TS guess comparisons.</span>
<span class="sd">        orbitals_level (str, optional): The level of theory to use for calculating MOs (for plotting).</span>
<span class="sd">        adaptive_levels (dict, optional): A dictionary of levels of theory for ranges of the number of heavy atoms in</span>
<span class="sd">                                          the molecule. Keys are tuples of (min_num_atoms, max_num_atoms), values are</span>
<span class="sd">                                          dictionaries with &#39;optfreq&#39; and &#39;sp&#39; as keys and levels of theory as values.</span>
<span class="sd">        rmgdatabase (RMGDatabase, optional): The RMG database object.</span>
<span class="sd">        job_types (dict, optional): A dictionary of job types to execute. Keys are job types, values are boolean.</span>
<span class="sd">        initial_trsh (dict, optional): Troubleshooting methods to try by default. Keys are ESS software,</span>
<span class="sd">                                       values are trshs.</span>
<span class="sd">        bath_gas (str, optional): A bath gas. Currently used in OneDMin to calc L-J parameters.</span>
<span class="sd">                                  Allowed values are He, Ne, Ar, Kr, H2, N2, O2.</span>
<span class="sd">        restart_dict (dict, optional): A restart dictionary parsed from a YAML restart file.</span>
<span class="sd">        max_job_time (int, optional): The maximal allowed job time on the server in hours.</span>
<span class="sd">        allow_nonisomorphic_2d (bool, optional): Whether to optimize species even if they do not have a 3D conformer</span>
<span class="sd">                                                 that is isomorphic to the 2D graph representation.</span>
<span class="sd">        memory (int, optional): The total allocated job memory in GB (14 by default).</span>
<span class="sd">        testing (bool, optional): Used for internal ARC testing (generating the object w/o executing it).</span>
<span class="sd">        dont_gen_confs (list, optional): A list of species labels for which conformer jobs were loaded from a restart</span>
<span class="sd">                                         file, or user-requested. Additional conformer generation should be avoided.</span>
<span class="sd">        confs_to_dft (int, optional): The number of lowest MD conformers to DFT at the conformers_level.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        project (str): The project&#39;s name. Used for naming the working directory.</span>
<span class="sd">        servers (list): A list of servers used for the present project.</span>
<span class="sd">        species_list (list): Contains input :ref:`ARCSpecies &lt;species&gt;` objects (both species and TSs).</span>
<span class="sd">        species_dict (dict): Keys are labels, values are :ref:`ARCSpecies &lt;species&gt;` objects.</span>
<span class="sd">        rxn_list (list): Contains input :ref:`ARCReaction &lt;reaction&gt;` objects.</span>
<span class="sd">        unique_species_labels (list): A list of species labels (checked for duplicates).</span>
<span class="sd">        adaptive_levels (dict): A dictionary of levels of theory for ranges of the number of heavy atoms in the</span>
<span class="sd">                                molecule. Keys are tuples of (min_num_atoms, max_num_atoms), values are</span>
<span class="sd">                                dictionaries with &#39;optfreq&#39; and &#39;sp&#39; as keys and levels of theory as values.</span>
<span class="sd">        job_dict (dict): A dictionary of all scheduled jobs. Keys are species / TS labels,</span>
<span class="sd">                         values are dictionaries where keys are job names (corresponding to</span>
<span class="sd">                         &#39;running_jobs&#39; if job is running) and values are the Job objects.</span>
<span class="sd">        running_jobs (dict): A dictionary of currently running jobs (a subset of `job_dict`).</span>
<span class="sd">                             Keys are species/TS label, values are lists of job names (e.g. &#39;conformer3&#39;, &#39;opt_a123&#39;).</span>
<span class="sd">        servers_jobs_ids (list): A list of relevant job IDs currently running on the server.</span>
<span class="sd">        output (dict): Output dictionary with status and final QM file paths for all species.</span>
<span class="sd">        ess_settings (dict): A dictionary of available ESS and a corresponding server list.</span>
<span class="sd">        initial_trsh (dict): Troubleshooting methods to try by default. Keys are ESS software, values are trshs.</span>
<span class="sd">        restart_dict (dict): A restart dictionary parsed from a YAML restart file.</span>
<span class="sd">        project_directory (str): Folder path for the project: the input file path or ARC/Projects/project-name.</span>
<span class="sd">        save_restart (bool): Whether to start saving a restart file. ``True`` only after all species are loaded</span>
<span class="sd">                             (otherwise saves a partial file and may cause loss of information).</span>
<span class="sd">        restart_path (str): Path to the `restart.yml` file to be saved.</span>
<span class="sd">        max_job_time (int): The maximal allowed job time on the server in hours.</span>
<span class="sd">        testing (bool): Used for internal ARC testing (generating the object w/o executing it).</span>
<span class="sd">        rmgdb (RMGDatabase): The RMG database object.</span>
<span class="sd">        allow_nonisomorphic_2d (bool): Whether to optimize species even if they do not have a 3D conformer that is</span>
<span class="sd">                                       isomorphic to the 2D graph representation.</span>
<span class="sd">        dont_gen_confs (list): A list of species labels for which conformer jobs were loaded from a restart file,</span>
<span class="sd">                               or user-requested. Additional conformer generation should be avoided for them.</span>
<span class="sd">        confs_to_dft (int): The number of lowest MD conformers to DFT at the conformers_level.</span>
<span class="sd">        memory (int): The total allocated job memory in GB (14 by default).</span>
<span class="sd">        job_types (dict): A dictionary of job types to execute. Keys are job types, values are boolean.</span>
<span class="sd">        bath_gas (str): A bath gas. Currently used in OneDMin to calc L-J parameters.</span>
<span class="sd">                        Allowed values are He, Ne, Ar, Kr, H2, N2, O2.</span>
<span class="sd">        composite_method (str): A composite method to use.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">ess_settings</span><span class="p">,</span> <span class="n">species_list</span><span class="p">,</span> <span class="n">project_directory</span><span class="p">,</span> <span class="n">composite_method</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">conformer_level</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">opt_level</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">freq_level</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sp_level</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">scan_level</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ts_guess_level</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">orbitals_level</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">adaptive_levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rmgdatabase</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initial_trsh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rxn_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bath_gas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">restart_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_job_time</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">allow_nonisomorphic_2d</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">testing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">dont_gen_confs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confs_to_dft</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmgdb</span> <span class="o">=</span> <span class="n">rmgdatabase</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span> <span class="o">=</span> <span class="n">restart_dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span> <span class="o">=</span> <span class="n">species_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span> <span class="o">=</span> <span class="n">rxn_list</span> <span class="k">if</span> <span class="n">rxn_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">=</span> <span class="n">project</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span> <span class="o">=</span> <span class="n">max_job_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span> <span class="o">=</span> <span class="n">ess_settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span> <span class="o">=</span> <span class="n">project_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span> <span class="o">=</span> <span class="n">allow_nonisomorphic_2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testing</span> <span class="o">=</span> <span class="n">testing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span> <span class="o">=</span> <span class="n">bath_gas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span> <span class="o">=</span> <span class="n">adaptive_levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confs_to_dft</span> <span class="o">=</span> <span class="n">confs_to_dft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dont_gen_confs</span> <span class="o">=</span> <span class="n">dont_gen_confs</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">species</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;running_jobs&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restore_running_jobs</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">restart_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;restart.yml&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>  <span class="c1"># init time for reporting status every 1 hr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> <span class="o">=</span> <span class="n">composite_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span> <span class="o">=</span> <span class="n">conformer_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span> <span class="o">=</span> <span class="n">ts_guess_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span> <span class="o">=</span> <span class="n">opt_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span> <span class="o">=</span> <span class="n">freq_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span> <span class="o">=</span> <span class="n">sp_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span> <span class="o">=</span> <span class="n">scan_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbitals_level</span> <span class="o">=</span> <span class="n">orbitals_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span> <span class="o">=</span> <span class="n">job_types</span> <span class="k">if</span> <span class="n">job_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_job_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_trsh</span> <span class="o">=</span> <span class="n">initial_trsh</span> <span class="k">if</span> <span class="n">initial_trsh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span><span class="p">):</span>
            <span class="n">rxn_info_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_reaction_labels_info_file</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loading RMG&#39;s families...&quot;</span><span class="p">)</span>
            <span class="n">rmgdb</span><span class="o">.</span><span class="n">load_families_only</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmgdb</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># update the ARCReaction object and generate an ARCSpecies object for its TS</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">r_species</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">p_species</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reactants</span><span class="p">:</span>
                        <span class="n">rxn</span><span class="o">.</span><span class="n">r_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">products</span><span class="p">:</span>
                        <span class="n">rxn</span><span class="o">.</span><span class="n">p_species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc</span><span class="p">)</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction_from_arc_species</span><span class="p">()</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">check_attributes</span><span class="p">()</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">determine_family</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmgdb</span><span class="p">)</span>
                <span class="n">family_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">family</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">family_text</span> <span class="o">=</span> <span class="s1">&#39;identified as belonging to RMG family </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">family_own_reverse</span><span class="p">:</span>
                        <span class="n">family_text</span> <span class="o">+=</span> <span class="s2">&quot;, which is its own reverse&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Considering reaction: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">family_text</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;(</span><span class="si">{0}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">family_text</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">display</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span><span class="p">)</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">determine_rxn_charge</span><span class="p">()</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">determine_rxn_multiplicity</span><span class="p">()</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;TS</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">label</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">family_text</span><span class="p">:</span>
                        <span class="n">family_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">(&#39;</span> <span class="o">+</span> <span class="n">family_text</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">family_text</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_xyz_guess</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;user guess&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="p">:</span>
                    <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;user guess&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_xyz_guess</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="s1">&#39;user guess&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">method</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="p">]):</span>
                    <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> user guesses&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_xyz_guess</span><span class="p">)))</span>
                <span class="n">auto_tst</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">reverse_auto_tst</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;autotst&#39;</span><span class="p">:</span>
                        <span class="n">auto_tst</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;reverse_autotst&#39;</span><span class="p">:</span>
                        <span class="n">reverse_auto_tst</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">family_own_reverse</span> <span class="ow">and</span> <span class="n">auto_tst</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reverse_auto_tst</span><span class="p">:</span>
                    <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;reverse_autotst&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">]):</span>
                    <span class="n">ts_species</span> <span class="o">=</span> <span class="n">ARCSpecies</span><span class="p">(</span><span class="n">is_ts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">,</span> <span class="n">rxn_label</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">label</span><span class="p">,</span>
                                            <span class="n">multiplicity</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">generate_thermo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                            <span class="n">ts_methods</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="p">,</span> <span class="n">ts_number</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="n">ts_species</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">reactant</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="k">for</span> <span class="n">reactant</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">r_species</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ts_species</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># The TS species was already loaded from a restart dict or an Arkane YAML file</span>
                    <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">:</span>
                            <span class="n">ts_species</span> <span class="o">=</span> <span class="n">spc</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">ts_species</span><span class="o">.</span><span class="n">rxn_label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ts_species</span><span class="o">.</span><span class="n">rxn_label</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">label</span>
                <span class="n">rxn</span><span class="o">.</span><span class="n">ts_species</span> <span class="o">=</span> <span class="n">ts_species</span>
                <span class="c1"># Generate TSGuess objects for all methods, start with the user guesses</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">user_guess</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_xyz_guess</span><span class="p">):</span>  <span class="c1"># this is a list of guesses, could be empty</span>
                    <span class="n">ts_species</span><span class="o">.</span><span class="n">ts_guesses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TSGuess</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;user guess </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">xyz</span><span class="o">=</span><span class="n">user_guess</span><span class="p">,</span>
                                                         <span class="n">rmg_reaction</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">tsm</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">ts_methods</span><span class="p">:</span>
                    <span class="c1"># loop through all ts methods of this reaction, generate a TSGuess object if not a user guess</span>
                    <span class="k">if</span> <span class="s1">&#39;user guess&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tsm</span><span class="p">:</span>
                        <span class="n">rmg_reaction</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span>
                        <span class="k">if</span> <span class="n">tsm</span> <span class="o">==</span> <span class="s1">&#39;reverse_autotst&#39;</span><span class="p">:</span>
                            <span class="n">rmg_reaction</span> <span class="o">=</span> <span class="n">Reaction</span><span class="p">(</span><span class="n">reactants</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span><span class="o">.</span><span class="n">products</span><span class="p">,</span>
                                                    <span class="n">products</span><span class="o">=</span><span class="n">rxn</span><span class="o">.</span><span class="n">rmg_reaction</span><span class="o">.</span><span class="n">reactants</span><span class="p">)</span>
                        <span class="n">family</span> <span class="o">=</span> <span class="n">rxn</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">label</span> <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">family</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">ts_species</span><span class="o">.</span><span class="n">ts_guesses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TSGuess</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">tsm</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">family</span><span class="p">,</span> <span class="n">rmg_reaction</span><span class="o">=</span><span class="n">rmg_reaction</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ts_guess</span> <span class="ow">in</span> <span class="n">ts_species</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                    <span class="c1"># Execute the TS guess methods that don&#39;t require optimized reactants and products</span>
                    <span class="k">if</span> <span class="s1">&#39;autotst&#39;</span> <span class="ow">in</span> <span class="n">ts_guess</span><span class="o">.</span><span class="n">method</span> <span class="ow">and</span> <span class="n">ts_guess</span><span class="o">.</span><span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">reverse</span> <span class="o">=</span> <span class="s1">&#39; in the reverse direction&#39;</span> <span class="k">if</span> <span class="s1">&#39;reverse&#39;</span> <span class="ow">in</span> <span class="n">ts_guess</span><span class="o">.</span><span class="n">method</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Trying to generating a TS guess for </span><span class="si">{0}</span><span class="s1"> reaction </span><span class="si">{1}</span><span class="s1"> using AutoTST</span><span class="si">{2}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">ts_guess</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">reverse</span><span class="p">))</span>
                        <span class="n">ts_guess</span><span class="o">.</span><span class="n">t0</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ts_guess</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">autotst</span><span class="p">(</span><span class="n">rmg_reaction</span><span class="o">=</span><span class="n">ts_guess</span><span class="o">.</span><span class="n">rmg_reaction</span><span class="p">,</span> <span class="n">reaction_family</span><span class="o">=</span><span class="n">ts_guess</span><span class="o">.</span><span class="n">family</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">TSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not generate an AutoTST guess for reaction </span><span class="si">{0}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">Got: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">rxn</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">))</span>
                        <span class="n">ts_guess</span><span class="o">.</span><span class="n">success</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">ts_guess</span><span class="o">.</span><span class="n">xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span>
                        <span class="n">ts_guess</span><span class="o">.</span><span class="n">execution_time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">ts_guess</span><span class="o">.</span><span class="n">t0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># spawn other methods as needed when they are implemented (job_type = &#39;ts_guess&#39;);</span>
                        <span class="c1"># add to job_dict only spawn if `ts_guess.xyz is None` (restart)</span>
                        <span class="k">pass</span>

        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">ARCSpecies</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="s1">&#39;Each species in `species_list` must be an ARCSpecies object.&#39;</span>
                                   <span class="s1">&#39; Got type </span><span class="si">{0}</span><span class="s1"> for </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">species</span><span class="p">),</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="s1">&#39;Each species in `species_list` has to have a unique label.&#39;</span>
                                   <span class="s1">&#39; Label of species </span><span class="si">{0}</span><span class="s1"> is not unique.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;; Restarted ARC at </span><span class="si">{0}</span><span class="s1">; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">yml_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;1d_rotors&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_rotors</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">determine_rotors</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;opt converged; &#39;</span>
                <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># initialize before running the first job</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">species</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Species </span><span class="si">{0}</span><span class="s1"> is monoatomic&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">:</span>
                        <span class="c1"># generate a simple &quot;Symbol   0.0   0.0   0.0&quot; xyz matrix</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">symbol</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">symbol</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not determine element of monoatomic species </span><span class="si">{0}</span><span class="s1">.&#39;</span>
                                           <span class="s1">&#39; Assuming element is </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">symbol</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">symbol</span> <span class="o">+</span> <span class="s1">&#39;   0.0   0.0   0.0&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="o">=</span> <span class="n">symbol</span> <span class="o">+</span> <span class="s1">&#39;   0.0   0.0   0.0&#39;</span>
                    <span class="k">if</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> \
                            <span class="ow">and</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>\
                            <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]:</span>
                        <span class="c1"># No need to run opt/freq jobs for a monoatomic species other than sp (or composite if relevant)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_onedmin_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
                    <span class="c1"># For restarting purposes: check before running jobs whether they were already terminated</span>
                    <span class="c1"># (check self.output) or whether they are &quot;currently running&quot; (check self.job_dict)</span>
                    <span class="c1"># This section takes care of restarting a Species (including a TS), but does not</span>
                    <span class="c1"># deal with conformers nor with ts_guesses</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>\
                            <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> <span class="ow">and</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>\
                            <span class="ow">and</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span>\
                            <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;opt converged&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>\
                            <span class="ow">and</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> \
                            <span class="ow">and</span> <span class="s1">&#39;geo&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;opt converged&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                        <span class="c1"># opt is done</span>
                        <span class="k">if</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span>\
                                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;1d_rotors&#39;</span><span class="p">]:</span>
                            <span class="c1"># restart-related checks are performed in run_scan_jobs()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Species is loaded from an Arkane YAML file (no need to execute any job)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ALL converged&#39;</span>
                <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="c1"># This is a TS loaded from a YAML file</span>
                    <span class="n">species</span><span class="o">.</span><span class="n">ts_conf_spawned</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schedule_jobs</span><span class="p">()</span>

<div class="viewcode-block" id="Scheduler.schedule_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.schedule_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">schedule_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The main job scheduling block</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">species</span><span class="o">.</span><span class="n">conformers</span>\
                    <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">species</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">]):</span>
                <span class="c1"># the species has no xyz, but has conformers and at least one of the conformers has energy</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">determine_most_stable_conformer</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">species</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_conformer_jobs</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span> <span class="o">!=</span> <span class="p">{}:</span>  <span class="c1"># loop while jobs are still running</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Currently running jobs:</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="p">:</span>
                <span class="c1"># look for completed jobs and decide what jobs to run next</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_servers_jobs_ids</span><span class="p">()</span>  <span class="c1"># updates `self.servers_jobs_ids`</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">job_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="p">[</span><span class="mi">9</span><span class="p">:])</span>  <span class="c1"># the conformer number. parsed from a string like &#39;conformer12&#39;.</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                            <span class="c1"># this is a completed conformer job</span>
                            <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">parse_conformer</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                            <span class="c1"># Just terminated a conformer job.</span>
                            <span class="c1"># Are there additional conformer jobs currently running for this species?</span>
                            <span class="k">for</span> <span class="n">spec_jobs</span> <span class="ow">in</span> <span class="n">job_list</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">spec_jobs</span><span class="p">:</span>
                                    <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># All conformer jobs terminated.</span>
                                <span class="c1"># Check isomorphism and run opt on most stable conformer geometry.</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Conformer jobs for </span><span class="si">{0}</span><span class="s1"> successfully terminated.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">label</span><span class="p">))</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">determine_most_likely_ts_conformer</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">determine_most_stable_conformer</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>  <span class="c1"># also checks isomorphism</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="c1"># if initial_xyz is None, then we&#39;re probably troubleshooting conformers, don&#39;t opt</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="n">job_name</span>\
                            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="c1"># val is &#39;opt1&#39;, &#39;opt2&#39;, etc., or &#39;optfreq1&#39;, optfreq2&#39;, etc.</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_opt_geo</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                                    <span class="c1"># This was originally a composite method, probably troubleshooted as &#39;opt&#39;</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span>\
                                            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">:</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is an &#39;optfreq&#39; job type</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">check_freq_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_orbitals_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_onedmin_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">in</span> <span class="n">job_name</span>\
                            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="c1"># this is NOT an &#39;optfreq&#39; job</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_freq_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">in</span> <span class="n">job_name</span>\
                            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_sp_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">in</span> <span class="n">job_name</span>\
                            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_composite_geo</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                                    <span class="c1"># This wasn&#39;t originally a composite method, probably troubleshooted as such</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span>\
                                            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span>\
                                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">run_onedmin_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;scan&#39;</span> <span class="ow">in</span> <span class="n">job_name</span>\
                            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_scan_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;orbitals&#39;</span> <span class="ow">in</span> <span class="n">job_name</span>\
                            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;orbitals&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;orbitals&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="c1"># copy the orbitals file to the species / TS output folder</span>
                            <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;rxns&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
                            <span class="n">orbitals_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                                         <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;orbitals.fchk&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">):</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_orbitals_file</span><span class="p">,</span> <span class="n">orbitals_path</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;onedmin&#39;</span> <span class="ow">in</span> <span class="n">job_name</span>\
                            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;onedmin&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;onedmin&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="c1"># copy the lennard_jones file to the species output folder (TS&#39;s don&#39;t have L-J data)</span>
                            <span class="n">lj_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                                          <span class="s1">&#39;lennard_jones.dat&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_lj_file</span><span class="p">):</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_lj_file</span><span class="p">,</span> <span class="n">lj_output_path</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;OneDMin converged; &#39;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_transport_data</span><span class="p">(</span>
                                    <span class="n">lj_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                                         <span class="s1">&#39;lennard_jones.dat&#39;</span><span class="p">),</span>
                                    <span class="n">opt_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">],</span> <span class="n">bath_gas</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">bath_gas</span><span class="p">,</span> <span class="n">opt_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;ff_param_fit&#39;</span> <span class="ow">in</span> <span class="n">job_name</span>\
                            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;ff_param_fit&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;ff_param_fit&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="n">mmff94_fallback</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                            <span class="c1"># copy the fitting file to the species output folder</span>
                            <span class="n">ff_param_fit_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                                             <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ff_param_fit_path</span><span class="p">):</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ff_param_fit_path</span><span class="p">)</span>
                            <span class="n">ff_param_fit_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_param_fit_path</span><span class="p">,</span> <span class="s1">&#39;gaussian.out&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">):</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="n">ff_param_fit_path</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;ff_param_fit converged; &#39;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">spawn_md_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">mmff94_fallback</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mmff94_fallback</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="n">mmff94_fallback</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Force field parameter fitting job in Gaussian failed. Generating standard &#39;</span>
                                         <span class="s1">&#39;MMFF94 conformers instead of fitting a force field for species </span><span class="si">{0}</span><span class="s1">, although &#39;</span>
                                         <span class="s1">&#39;its force_field attribute was set to &quot;fit&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">force_field</span> <span class="o">=</span> <span class="s1">&#39;MMFF94&#39;</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">generate_conformers</span><span class="p">(</span><span class="n">confs_to_dft</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">confs_to_dft</span><span class="p">,</span>
                                                                         <span class="n">plot_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                                                                                                <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span>
                                                                                                <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span>
                                                                                                <span class="s1">&#39;conformers&#39;</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">process_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="s1">&#39;gromacs&#39;</span> <span class="ow">in</span> <span class="n">job_name</span>\
                            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;gromacs&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="p">:</span>
                        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;gromacs&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
                        <span class="n">successful_server_termination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">successful_server_termination</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">check_md_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_conf_spawned</span>\
                        <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">tsg</span><span class="o">.</span><span class="n">success</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">]):</span>
                    <span class="c1"># This is a TS Species for which conformers haven&#39;t been spawned, and all .success flags</span>
                    <span class="c1"># contain a values (whether ``True`` or ``False``)</span>
                    <span class="c1"># We&#39;re ready to spawn conformers for this TS Species</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">generate_conformers</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_ts_conformer_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_conf_spawned</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">job_list</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span>
                                        <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_conf_spawned</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_all_done</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                        <span class="c1"># delete the label only if it represents an empty dictionary</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="ow">and</span> <span class="n">job_list</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># wait 30 sec before bugging the servers again.</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_time</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">3600</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Currently running jobs:</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">))</span>

        <span class="c1"># After exiting the Scheduler while loop, append all YAML species not directly calculated to the species_dict:</span>
        <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">yml_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">spc</span></div>

<div class="viewcode-block" id="Scheduler.run_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">conformer</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scan_trsh</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">scan_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">max_job_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function for running (all) jobs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_job_time</span> <span class="o">=</span> <span class="n">max_job_time</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_job_time</span>  <span class="c1"># if it&#39;s None, set to default</span>
        <span class="n">ess_trsh_methods</span> <span class="o">=</span> <span class="n">ess_trsh_methods</span> <span class="k">if</span> <span class="n">ess_trsh_methods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">pivots</span> <span class="o">=</span> <span class="n">pivots</span> <span class="k">if</span> <span class="n">pivots</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
        <span class="n">memory</span> <span class="o">=</span> <span class="n">memory</span> <span class="k">if</span> <span class="n">memory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory</span>
        <span class="n">checkfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span>  <span class="c1"># defaults to None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">most_stable_conformer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">,</span> <span class="s1">&#39;optfreq&#39;</span><span class="p">]</span> \
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_checkfiles</span><span class="p">:</span>
            <span class="n">checkfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_checkfiles</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">most_stable_conformer</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">level_of_theory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_adaptive_level</span><span class="p">(</span><span class="n">original_level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span>
                                                            <span class="n">heavy_atoms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_heavy_atoms</span><span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">ess_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">,</span> <span class="n">species_name</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span>
                  <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">fine</span><span class="p">,</span>
                  <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">software</span><span class="p">,</span> <span class="n">is_ts</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span>
                  <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span> <span class="n">initial_trsh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_trsh</span><span class="p">,</span>
                  <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">max_job_time</span><span class="o">=</span><span class="n">max_job_time</span><span class="p">,</span> <span class="n">scan_trsh</span><span class="o">=</span><span class="n">scan_trsh</span><span class="p">,</span>
                  <span class="n">scan_res</span><span class="o">=</span><span class="n">scan_res</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">,</span> <span class="n">checkfile</span><span class="o">=</span><span class="n">checkfile</span><span class="p">,</span> <span class="n">bath_gas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bath_gas</span><span class="p">,</span>
                  <span class="n">number_of_radicals</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">number_of_radicals</span><span class="p">,</span> <span class="n">conformers</span><span class="o">=</span><span class="n">confs</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">software</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">conformer</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># this is NOT a conformer DFT job</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>  <span class="c1"># mark as a running job</span>
                <span class="k">if</span> <span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                    <span class="c1"># Jobs of this type haven&#39;t been spawned for label</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">job_type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">job_type</span><span class="p">][</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="n">job_type</span><span class="p">][</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Running a conformer DFT job. Append differently to job_dict.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;conformer</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conformer</span><span class="p">))</span>  <span class="c1"># mark as a running job</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">conformer</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span>  <span class="c1"># save job object</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="n">conformer</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>  <span class="c1"># run the job</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">server</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">server</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.end_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.end_job">[docs]</a>    <span class="k">def</span> <span class="nf">end_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function for checking job status, saving in csv file, and downloading output files.</span>
<span class="sd">        Returns ``True`` if job terminated successfully on the server, ``False`` otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">determine_job_status</span><span class="p">()</span>  <span class="c1"># also downloads output file</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;orbitals&#39;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Tried to determine status of job </span><span class="si">{0}</span><span class="s1">, but it seems like the job never ran.&#39;</span>
                               <span class="s1">&#39; Re-running job.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_type</span><span class="p">,</span>
                             <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">trsh</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">memory_gb</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">conformer</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan</span><span class="p">,</span>
                             <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">occ</span><span class="p">,</span> <span class="n">scan_trsh</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan_trsh</span><span class="p">,</span> <span class="n">scan_res</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan_res</span><span class="p">,</span>
                             <span class="n">max_job_time</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">max_job_time</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">job_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;running&#39;</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;running&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">job_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">job</span><span class="o">.</span><span class="n">write_completed_job_to_csv_file</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  Ending job </span><span class="si">{name}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> (run time: </span><span class="si">{time}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                                                                    <span class="n">time</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">))</span>\
                    <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;optfreq&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]:</span>
                <span class="n">check_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;check.chk&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">check_path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;conformer&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_checkfiles</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">conformer</span><span class="p">]</span> <span class="o">=</span> <span class="n">check_path</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="n">check_path</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Scheduler.run_conformer_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_conformer_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">run_conformer_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select the most stable conformer for each species using molecular dynamics (force fields) and subsequently</span>
<span class="sd">        spawning opt jobs at the conformer level of theory, usually a reasonable yet cheap DFT, e.g., b97d3/6-31+g(d,p).</span>
<span class="sd">        The resulting conformer is saved in a string format xyz in the Species initial_xyz attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log_info_printed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_species_labels</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="s1">&#39;opt converged&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">])</span> \
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;geo&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dont_gen_confs</span>
                         <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(</span><span class="n">get_cheap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># This is not a TS, opt (/composite) did not converged nor running, and conformer energies were not set.</span>
                <span class="c1"># Also, either &#39;conformers&#39; are set to True in job_types (and it&#39;s not in dont_gen_confs),</span>
                <span class="c1"># or they are set to False (or it&#39;s in dont_gen_confs), but the species has no 3D information.</span>
                <span class="c1"># Generate conformers.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">log_info_printed</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Starting (non-TS) species conformational analysis...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">log_info_printed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">force_field</span> <span class="o">==</span> <span class="s1">&#39;fit&#39;</span><span class="p">:</span>
                    <span class="c1"># first run a Gaussian blyp/svp/svpfit job for force field parameters fitting</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">cheap_conformer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_cheap_conformer</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_force_field_fit_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">force_field</span> <span class="o">==</span> <span class="s1">&#39;cheap&#39;</span><span class="p">:</span>
                        <span class="c1"># just embed in RDKit and use MMFF94 for opt and energies</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># run the combinatorial method w/o fitting a force field</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">generate_conformers</span><span class="p">(</span><span class="n">confs_to_dft</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">confs_to_dft</span><span class="p">,</span>
                                                                     <span class="n">plot_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                                         <span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span>
                                                                         <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;conformers&#39;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">]:</span>
                <span class="c1"># we&#39;re not running conformer jobs</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">:</span>
                    <span class="c1"># the species was defined with xyz&#39;s</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_ts_conformer_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_ts_conformer_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">run_ts_conformer_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn opt jobs at the ts_guesses level of theory for the TS guesses</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span><span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                     <span class="n">xyzs</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">xyz</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
                                     <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span><span class="p">,</span>
                                     <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                     <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">is_ts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">ts_methods</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="c1"># proceed only if opt (/composite) not already spawned</span>
                <span class="n">rxn</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rxn</span> <span class="o">=</span> <span class="s1">&#39; of reaction &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Only one TS guess is available for species </span><span class="si">{0}{1}</span><span class="s1">,&#39;</span>
                            <span class="s1">&#39; using it for geometry optimization&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">rxn</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">method</span></div>

<div class="viewcode-block" id="Scheduler.run_opt_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_opt_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_opt_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a geometry optimization job. The initial guess is taken from the `initial_xyz` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>  <span class="c1"># Check whether or not opt jobs have been spawned yet</span>
            <span class="c1"># we&#39;re spawning the first opt job for this species</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="s1">&#39;Cannot execute opt job for </span><span class="si">{0}</span><span class="s1"> without xyz (got None for Species.initial_xyz)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">label</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">,</span>
                     <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_composite_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_composite_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_composite_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a composite job (e.g., CBS-QB3) using &#39;final_xyz&#39; for species ot TS &#39;label&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Cannot run </span><span class="si">{0}</span><span class="s1"> as a composite method, without specifying a method.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>  <span class="c1"># Check whether or not composite jobs have been spawned yet</span>
            <span class="c1"># we&#39;re spawning the first composite job for this species</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;composite&#39;</span><span class="p">,</span>
                     <span class="n">fine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Scheduler.run_freq_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_freq_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_freq_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a freq job using &#39;final_xyz&#39; for species ot TS &#39;label&#39;.</span>
<span class="sd">        If this was originally a composite job, run an appropriate separate freq job outputting the Hessian.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;freq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>  <span class="c1"># Check whether or not freq jobs have been spawned yet</span>
            <span class="c1"># we&#39;re spawning the first freq job for this species</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">,</span>
                         <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;freq&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_sp_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_sp_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_sp_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a single point job using &#39;final_xyz&#39; for species ot TS &#39;label&#39;.</span>
<span class="sd">        If the method is MRCI, first spawn a simple CCSD job, and use orbital determination to run the MRCI job</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># determine_occ(label=self.label, xyz=self.xyz, charge=self.charge)</span>
        <span class="k">if</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>  <span class="c1"># Check whether or not single point jobs have been spawned yet</span>
            <span class="c1"># we&#39;re spawning the first sp job for this species</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;run_sp_job() was called for </span><span class="si">{0}</span><span class="s1"> which has a composite method level of theory&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">label</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;mrci&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                <span class="c1"># Parse orbital information from the CCSD job, then run MRCI</span>
                <span class="n">job0</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">jobname0</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_a&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">jobname0</span><span class="p">:</span>
                        <span class="n">jobname0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_a&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">job0</span> <span class="o">=</span> <span class="n">job</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">job0</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="n">core</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;NUMBER OF CORE ORBITALS&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">core</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="s1">&#39;NUMBER OF VALENCE ORBITALS&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="o">*</span> <span class="n">core</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Could not determine number of core and valence orbitals from CCSD&#39;</span>
                                             <span class="s1">&#39; sp calculation for </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">occ</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">core</span>  <span class="c1"># the occupied orbitals are the core and valence orbitals</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="s1">&#39;ccsd/vdz&#39;</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;sp&#39;</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="n">occ</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># MRCI was requested but no sp job ran for this species, run CCSD first</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;running a CCSD job for </span><span class="si">{0}</span><span class="s1"> before MRCI&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="s1">&#39;ccsd/vdz&#39;</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;sp&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
            <span class="k">if</span> <span class="n">xyz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;sp&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_scan_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_scan_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">run_scan_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn rotor scan jobs using &#39;final_xyz&#39; for species or TS &#39;label&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;1d_rotors&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;scan&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>  <span class="c1"># Check whether or not rotor scan jobs have been spawned yet</span>
                <span class="c1"># we&#39;re spawning the first scan job for this species</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_rotors</span><span class="p">):</span>
                <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span>
                <span class="n">pivots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;scan_path&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>\
                        <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]:</span>
                    <span class="c1"># check this job isn&#39;t already running on the server or completed (from a restarted project):</span>
                    <span class="k">for</span> <span class="n">scan_job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">scan_job</span><span class="o">.</span><span class="n">pivots</span> <span class="o">==</span> <span class="n">pivots</span> <span class="ow">and</span> <span class="n">scan_job</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">,</span>
                                     <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">pivots</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_orbitals_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_orbitals_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_orbitals_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn orbitals job used for molecular orbital visualization</span>
<span class="sd">        Currently supporting QChem for printing the orbitals, the output could be visualized using IQMol</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;orbitals&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;orbitals&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">orbitals_level</span><span class="p">,</span>
                         <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;orbitals&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_onedmin_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_onedmin_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_onedmin_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a lennard-jones calculation using OneDMin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;onedmin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot execute a Lennard Jones job without the OneDMin software&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;onedmin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;onedmin&#39;</span><span class="p">,</span>
                         <span class="n">level_of_theory</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_force_field_fit_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_force_field_fit_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_force_field_fit_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spawn a force field parameter fitting job (currently only Gaussian is supported for this task).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">svpfit_output_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>\
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">svpfit_output_file</span><span class="p">):</span>
            <span class="c1"># a force field parameter fit job was already spawned, use this file</span>
            <span class="n">ff_param_fit_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ff_param_fit_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ff_param_fit_path</span><span class="p">)</span>
            <span class="n">ff_param_fit_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ff_param_fit_path</span><span class="p">,</span> <span class="s1">&#39;gaussian.out&#39;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">svpfit_output_file</span><span class="p">,</span> <span class="n">ff_param_fit_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;ff_param_fit converged; &#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spawn_md_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot execute a force field parameter fitting job in Gaussian. Gaussian  is missing from &#39;</span>
                         <span class="s1">&#39;the ess_settings dictionary. Generating standard MMFF94 conformers instead for &#39;</span>
                         <span class="s1">&#39;species </span><span class="si">{0}</span><span class="s1">, although its force_field attribute was set to &quot;fit&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">force_field</span> <span class="o">=</span> <span class="s1">&#39;MMFF94&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">generate_conformers</span><span class="p">(</span><span class="n">confs_to_dft</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">confs_to_dft</span><span class="p">,</span>
                                                         <span class="n">plot_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span>
                                                                                <span class="s1">&#39;conformers&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_conformers</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;ff_param_fit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">(),</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;ff_param_fit&#39;</span><span class="p">,</span>
                             <span class="n">level_of_theory</span><span class="o">=</span><span class="s1">&#39;blyp/svp/svpfit&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.run_gromacs_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.run_gromacs_job">[docs]</a>    <span class="k">def</span> <span class="nf">run_gromacs_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">confs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a Gromacs MD job.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            confs (str): The path to a YAML file with array-format coordinates to optimize.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;gromacs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Cannot execute a Gromacs MD job without the Gromacs software&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;gromacs&#39;</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="n">confs</span><span class="p">,</span>
                         <span class="n">radius</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.spawn_md_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.spawn_md_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_md_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">prev_conf_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_confs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Embed conformers and run a molecular dynamics optimization using a fitted force field.</span>
<span class="sd">        Then generate conformers using combinations of the detected torsion wells, and re-run until converging.</span>

<span class="sd">        Args:</span>
<span class="sd">            label (str): The species label.</span>
<span class="sd">            prev_conf_list (list, optional): The previous conformers (entries are two length lists, not dicts).</span>
<span class="sd">                                             If not given, a first Gromacs job will be spawned.</span>
<span class="sd">            num_confs (int, optional): The number of conformers to generate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">determine_rotors</span><span class="p">()</span>
        <span class="n">torsions</span><span class="p">,</span> <span class="n">tops</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(),</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">])</span>
            <span class="n">tops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">prev_conf_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># first time spawning MD jobs for this species</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">conformers</span><span class="o">.</span><span class="n">update_mol</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                                                     <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_list</span><span class="p">]</span>
                <span class="n">number_of_heavy_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">atom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atoms</span>
                                             <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">isNonHydrogen</span><span class="p">()])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">get_xyz</span><span class="p">()</span>
                <span class="n">number_of_heavy_atoms</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">xyz</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span>
                        <span class="n">number_of_heavy_atoms</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">num_confs</span> <span class="o">=</span> <span class="n">num_confs</span>\
                <span class="ow">or</span> <span class="n">conformers</span><span class="o">.</span><span class="n">determine_number_of_conformers_to_generate</span><span class="p">(</span><span class="n">heavy_atoms</span><span class="o">=</span><span class="n">number_of_heavy_atoms</span><span class="p">,</span>
                                                                         <span class="n">torsion_num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">torsions</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_list</span><span class="p">:</span>
                <span class="c1"># embed conformers (but don&#39;t optimize)</span>
                <span class="n">rd_mol</span><span class="p">,</span> <span class="n">rd_index_map</span> <span class="o">=</span> <span class="n">conformers</span><span class="o">.</span><span class="n">embed_rdkit</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">mol</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">num_confs</span><span class="o">=</span><span class="n">num_confs</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rd_mol</span><span class="o">.</span><span class="n">GetNumConformers</span><span class="p">()):</span>
                    <span class="n">conf</span><span class="p">,</span> <span class="n">coord</span> <span class="o">=</span> <span class="n">rd_mol</span><span class="o">.</span><span class="n">GetConformer</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">GetNumAtoms</span><span class="p">()):</span>
                        <span class="n">pt</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">GetAtomPosition</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                        <span class="n">coord</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">z</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">rd_index_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">coord</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[</span><span class="n">rd_index_map</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coord</span><span class="p">)]</span>  <span class="c1"># reorder</span>
                    <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
            <span class="n">embedded_confs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                               <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;embedded_conformers.yml&#39;</span><span class="p">)</span>  <span class="c1"># list of lists</span>
            <span class="n">save_yaml_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">embedded_confs_path</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_gromacs_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="n">embedded_confs_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># a previous Gromacs job was submitted, generate specific conformers via deduce_new_conformers()</span>
            <span class="n">confs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">confs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                      <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;conformers.yml&#39;</span><span class="p">)</span>  <span class="c1"># list of dicts</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">confs_path</span><span class="p">):</span>
                <span class="n">confs</span> <span class="o">=</span> <span class="n">read_yaml_file</span><span class="p">(</span><span class="n">confs_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">prev_conf</span> <span class="ow">in</span> <span class="n">prev_conf_list</span><span class="p">:</span>
                <span class="n">confs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;xyz&#39;</span><span class="p">:</span> <span class="n">prev_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;FF energy&#39;</span><span class="p">:</span> <span class="n">prev_conf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;Gromacs&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">confs</span><span class="p">)})</span>
            <span class="n">save_yaml_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">confs_path</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">confs</span><span class="p">)</span>  <span class="c1"># save for the next iteration and for archiving</span>

            <span class="n">confs</span> <span class="o">=</span> <span class="n">conformers</span><span class="o">.</span><span class="n">determine_dihedrals</span><span class="p">(</span><span class="n">confs</span><span class="p">,</span> <span class="n">torsions</span><span class="p">)</span>
            <span class="n">new_conformers</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">conformers</span><span class="o">.</span><span class="n">deduce_new_conformers</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">conformers</span><span class="o">=</span><span class="n">confs</span><span class="p">,</span> <span class="n">torsions</span><span class="o">=</span><span class="n">torsions</span><span class="p">,</span>
                                                                 <span class="n">tops</span><span class="o">=</span><span class="n">tops</span><span class="p">,</span> <span class="n">mol_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol_list</span><span class="p">,</span>
                                                                 <span class="n">plot_path</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">new_confs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;calcs&#39;</span><span class="p">,</span> <span class="s1">&#39;Species&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span>
                                          <span class="s1">&#39;ff_param_fit&#39;</span><span class="p">,</span> <span class="s1">&#39;new_conformers.yml&#39;</span><span class="p">)</span>  <span class="c1"># list of lists</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_conf</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">new_conf</span> <span class="ow">in</span> <span class="n">new_conformers</span><span class="p">]</span>
            <span class="n">save_yaml_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">new_confs_path</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">coords</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_gromacs_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="n">new_confs_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.process_conformers"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.process_conformers">[docs]</a>    <span class="k">def</span> <span class="nf">process_conformers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the generated conformers and spawn DFT jobs at the conformer_level.</span>
<span class="sd">        If more than one conformer is available, they will be optimized at the DFT conformer_level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span><span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                     <span class="n">xyzs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="p">,</span>
                                     <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                     <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">is_ts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># before optimization</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="kc">None</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="p">,</span>
                                 <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Only one conformer is available for species </span><span class="si">{0}</span><span class="s1">, &#39;</span>
                            <span class="s1">&#39;using it as initial xyz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># check whether this conformer is isomorphic to the species 2D graph representation</span>
                <span class="c1"># (since this won&#39;t be checked in determine_most_stable_conformer)</span>
                <span class="n">is_isomorphic</span><span class="p">,</span> <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b_mol</span> <span class="o">=</span> <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span><span class="p">,</span>
                                               <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                               <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">SanitizationError</span><span class="p">:</span>
                    <span class="n">b_mol</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">b_mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="n">check_isomorphism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">b_mol</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not determine isomorphism for charged species </span><span class="si">{0}</span><span class="s1">. Got the &#39;</span>
                                         <span class="s1">&#39;following error:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not determine isomorphism for (non-charged) species </span><span class="si">{0}</span><span class="s1">. Got the &#39;</span>
                                         <span class="s1">&#39;following error:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The only conformer for species </span><span class="si">{0}</span><span class="s1"> was found to be isomorphic &#39;</span>
                                    <span class="s1">&#39;with the 2D graph representation </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">b_mol</span><span class="o">.</span><span class="n">toSMILES</span><span class="p">()))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;conformer passed isomorphism check; &#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;The only conformer for species </span><span class="si">{0}</span><span class="s1"> is not isomorphic &#39;</span>
                                     <span class="s1">&#39;with the 2D graph representation </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">b_mol</span><span class="o">.</span><span class="n">toSMILES</span><span class="p">()))</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using this conformer anyway (allow_nonisomorphic_2d was set to True)&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Not using this conformer (to change this behavior, set allow_nonisomorphic_2d &#39;</span>
                                        <span class="s1">&#39;to True)&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span><span class="p">,</span> <span class="n">spawn_jobs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">spawn_jobs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_freq_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;1d_rotors&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_scan_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;onedmin&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_onedmin_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;orbitals&#39;</span><span class="p">]:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_orbitals_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_composite_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.parse_conformer"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.parse_conformer">[docs]</a>    <span class="k">def</span> <span class="nf">parse_conformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse E0 (kJ/mol) from the conformer opt output file.</span>
<span class="sd">        For species, save it in the Species.conformer_energies attribute.</span>
<span class="sd">        Fot TSs, save it in the TSGuess.energy attribute, and also parse the geometry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="n">log</span> <span class="o">=</span> <span class="n">determine_qm_software</span><span class="p">(</span><span class="n">fullpath</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">loadGeometry</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">loadEnergy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.001</span>  <span class="c1"># in kJ/mol</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">opt_xyz</span> <span class="o">=</span> <span class="n">get_xyz_string</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">numbers</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Energy for TSGuess </span><span class="si">{0}</span><span class="s1"> of </span><span class="si">{1}</span><span class="s1"> is </span><span class="si">{2:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">energy</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">loadEnergy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.001</span>  <span class="c1"># in kJ/mol</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_xyz_string</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">numbers</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Energy for conformer </span><span class="si">{0}</span><span class="s1"> of </span><span class="si">{1}</span><span class="s1"> is </span><span class="si">{2:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Conformer </span><span class="si">{i}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> did not converge!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span></div>

<div class="viewcode-block" id="Scheduler.determine_most_stable_conformer"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.determine_most_stable_conformer">[docs]</a>    <span class="k">def</span> <span class="nf">determine_most_stable_conformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the most stable conformer for a species (which is not a TS).</span>
<span class="sd">        Also run an isomorphism check.</span>
<span class="sd">        Save the resulting xyz as `initial_xyz`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;The determine_most_stable_conformer() method does not deal with transition&#39;</span>
                                 <span class="s1">&#39; state guesses.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;conformers&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No conformer converged for species </span><span class="si">{0}</span><span class="s1">! Trying to troubleshoot conformer jobs...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">label</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span>
                                      <span class="n">conformer</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">conformer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">xyzs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">:</span>
                <span class="n">xyzs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">log</span> <span class="o">=</span> <span class="n">determine_qm_software</span><span class="p">(</span><span class="n">fullpath</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">coords</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">loadGeometry</span><span class="p">()</span>
                    <span class="k">except</span> <span class="n">RMGInputError</span><span class="p">:</span>
                        <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xyzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_xyz_string</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">numbers</span><span class="o">=</span><span class="n">number</span><span class="p">))</span>
            <span class="n">xyzs_in_original_order</span> <span class="o">=</span> <span class="n">xyzs</span>
            <span class="n">energies</span><span class="p">,</span> <span class="n">xyzs</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">,</span> <span class="n">xyzs</span><span class="p">))))</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span><span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                         <span class="n">xyzs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="p">,</span>
                                         <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                         <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">is_ts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">energies</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="p">)</span>  <span class="c1"># after optimization</span>
            <span class="c1"># Run isomorphism checks if a 2D representation is available</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xyzs</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">b_mol</span> <span class="o">=</span> <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                                   <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">except</span> <span class="n">SanitizationError</span><span class="p">:</span>
                        <span class="n">b_mol</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">b_mol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="n">check_isomorphism</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">b_mol</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not determine isomorphism for charged species </span><span class="si">{0}</span><span class="s1">. &#39;</span>
                                             <span class="s1">&#39;Optimizing the most stable conformer anyway. Got the &#39;</span>
                                             <span class="s1">&#39;following error:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not determine isomorphism for (non-charged) species </span><span class="si">{0}</span><span class="s1">. &#39;</span>
                                             <span class="s1">&#39;Optimizing the most stable conformer anyway. Got the &#39;</span>
                                             <span class="s1">&#39;following error:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                            <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Most stable conformer for species </span><span class="si">{0}</span><span class="s1"> was found to be isomorphic &#39;</span>
                                            <span class="s1">&#39;with the 2D graph representation </span><span class="si">{1}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">b_mol</span><span class="o">.</span><span class="n">toSMILES</span><span class="p">()))</span>
                                <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;most stable conformer (</span><span class="si">{0}</span><span class="s1">) passed isomorphism &#39;</span> \
                                                                <span class="s1">&#39;check; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;A conformer for species </span><span class="si">{0}</span><span class="s1"> was found to be isomorphic &#39;</span>
                                                <span class="s1">&#39;with the 2D graph representation </span><span class="si">{1}</span><span class="s1">. This conformer is </span><span class="si">{2:.2f}</span><span class="s1"> kJ/mol&#39;</span>
                                                <span class="s1">&#39; above the most stable one which corresponds to  </span><span class="si">{3}</span><span class="s1"> (and is not &#39;</span>
                                                <span class="s1">&#39;isomorphic). Using the isomorphic conformer for further geometry &#39;</span>
                                                <span class="s1">&#39;optimization.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                 <span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">toSMILES</span><span class="p">(),</span>
                                                 <span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.001</span><span class="p">,</span>
                                                 <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                    <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                                                    <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyz</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;most stable conformer (</span><span class="si">{0}</span><span class="s1">) did not pass isomorphism &#39;</span> \
                                                                <span class="s1">&#39;check; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conf_is_isomorphic</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Most stable conformer for species </span><span class="si">{0}</span><span class="s1"> with structure </span><span class="si">{1}</span><span class="s1"> was found to &#39;</span>
                                               <span class="s1">&#39;be NON-isomorphic with the 2D graph representation </span><span class="si">{2}</span><span class="s1">. Searching for &#39;</span>
                                               <span class="s1">&#39;a different conformer that is isomorphic...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                <span class="n">label</span><span class="p">,</span> <span class="n">b_mol</span><span class="o">.</span><span class="n">toSMILES</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">toSMILES</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">smiles_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">xyzs</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">b_mol</span> <span class="o">=</span> <span class="n">molecules_from_xyz</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                                       <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">smiles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b_mol</span><span class="o">.</span><span class="n">toSMILES</span><span class="p">())</span>
                        <span class="k">except</span> <span class="p">(</span><span class="n">SanitizationError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                            <span class="n">smiles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Could not perceive molecule&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                        <span class="c1"># we&#39;ll optimize the most stable conformer even if it is not isomorphic to the 2D graph</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No conformer for </span><span class="si">{0}</span><span class="s1"> was found to be isomorphic with the 2D graph representation&#39;</span>
                                     <span class="s1">&#39; </span><span class="si">{1}</span><span class="s1"> (got: </span><span class="si">{2}</span><span class="s1">). Optimizing the most stable conformer anyway.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                      <span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">toSMILES</span><span class="p">(),</span> <span class="n">smiles_list</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;No conformer was found to be isomorphic with the 2D&#39;</span> \
                                                        <span class="s1">&#39; graph representation; &#39;</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Isomorphism check cannot be done for charged species </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
                        <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No conformer for </span><span class="si">{0}</span><span class="s1"> was found to be isomorphic with the 2D graph representation&#39;</span>
                                     <span class="s1">&#39; </span><span class="si">{1}</span><span class="s1"> (got: </span><span class="si">{2}</span><span class="s1">). NOT optimizing this species.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                      <span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">toSMILES</span><span class="p">(),</span> <span class="n">smiles_list</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Error: No conformer was found to be isomorphic with the 2D&#39;</span> \
                                                        <span class="s1">&#39; graph representation!; &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not run isomorphism check for species </span><span class="si">{0}</span><span class="s1"> due to missing 2D graph &#39;</span>
                               <span class="s1">&#39;representation. Using the most stable conformer for further geometry&#39;</span>
                               <span class="s1">&#39; optimization.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
                <span class="n">conformer_xyz</span> <span class="o">=</span> <span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">conformer_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">conformer_xyz</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">most_stable_conformer</span> <span class="o">=</span> <span class="n">xyzs_in_original_order</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">conformer_xyz</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.determine_most_likely_ts_conformer"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.determine_most_likely_ts_conformer">[docs]</a>    <span class="k">def</span> <span class="nf">determine_most_likely_ts_conformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the most likely TS conformer.</span>
<span class="sd">        Save the resulting xyz as `initial_xyz`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;determine_most_likely_ts_conformer() method only processes transition state guesses.&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">unsuccessful_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">All TS guesses for </span><span class="si">{0}</span><span class="s1"> terminated.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">unsuccessful_methods</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> All methods were successful: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39; Successful methods: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">successful_methods</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">yml_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39; Geometry parsed from YAML file.&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39; No method has converged!&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No TS methods for </span><span class="si">{0}</span><span class="s1"> have converged!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">unsuccessful_methods</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s1">&#39; Unsuccessful methods: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">unsuccessful_methods</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No guess converged for TS </span><span class="si">{0}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="c1"># for i, job in self.job_dict[label][&#39;conformers&#39;].items():</span>
            <span class="c1">#     self.troubleshoot_ess(label, job, level_of_theory=job.level_of_theory, job_type=&#39;conformer&#39;,</span>
            <span class="c1">#                           conformer=job.conformer)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># currently we take the most stable guess. We&#39;ll need to implement additional checks here:</span>
            <span class="c1"># - normal displacement mode of the imaginary frequency</span>
            <span class="c1"># - IRC isomorphism checks</span>
            <span class="n">rxn_txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span> <span class="ow">is</span> <span class="kc">None</span>\
                <span class="k">else</span> <span class="s1">&#39; of reaction </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Geometry *guesses* of successful TS guesses for </span><span class="si">{0}{1}</span><span class="s1">:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">rxn_txt</span><span class="p">))</span>
            <span class="n">e_min</span> <span class="o">=</span> <span class="n">min_list</span><span class="p">([</span><span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">])</span>
            <span class="n">i_min</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="o">==</span> <span class="n">e_min</span><span class="p">:</span>
                    <span class="n">i_min</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">index</span>
            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">i_min</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts</span> <span class="o">=</span> <span class="n">i_min</span>  <span class="c1"># change this if selecting a better TS later</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts_method</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">method</span>  <span class="c1"># change if selecting a better TS later</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">xyz</span>
                <span class="k">if</span> <span class="n">tsg</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># guess method and ts_level opt were both successful</span>
                    <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="o">-</span> <span class="n">e_min</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;TS guess </span><span class="si">{0}</span><span class="s1"> for </span><span class="si">{1}</span><span class="s1">. Method: </span><span class="si">{2}</span><span class="s1">, relative energy: </span><span class="si">{3:.2f}</span><span class="s1"> kJ/mol, guess execution &#39;</span>
                                <span class="s1">&#39;time: </span><span class="si">{4}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tsg</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">tsg</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">tsg</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">tsg</span><span class="o">.</span><span class="n">execution_time</span><span class="p">))</span>
                    <span class="c1"># for TSs, only use `draw_3d()`, not `show_sticks()` which gets connectivity wrong:</span>
                    <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">tsg</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;draw_3d&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">chosen_ts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SpeciesError</span><span class="p">(</span><span class="s1">&#39;Could not pair most stable conformer </span><span class="si">{0}</span><span class="s1"> of </span><span class="si">{1}</span><span class="s1"> to a respective &#39;</span>
                                   <span class="s1">&#39;TS guess&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i_min</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">save_conformers_file</span><span class="p">(</span><span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                         <span class="n">xyzs</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">opt_xyz</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
                                         <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ts_guess_level</span><span class="p">,</span>
                                         <span class="n">multiplicity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                                         <span class="n">charge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">is_ts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">energies</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">energy</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">],</span>
                                         <span class="n">ts_methods</span><span class="o">=</span><span class="p">[</span><span class="n">tsg</span><span class="o">.</span><span class="n">method</span> <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">])</span></div>

<div class="viewcode-block" id="Scheduler.parse_composite_geo"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.parse_composite_geo">[docs]</a>    <span class="k">def</span> <span class="nf">parse_composite_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a &#39;composite&#39; job converged successfully, and parse the geometry into `final_xyz`.</span>
<span class="sd">        Also checks (QA) that no imaginary frequencies were assigned for stable species,</span>
<span class="sd">        and that exactly one imaginary frequency was assigned for a TS.</span>
<span class="sd">        Returns ``True`` if the job converged successfully, ``False`` otherwise and troubleshoots.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;parsing composite geo for </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
        <span class="n">freq_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="n">log</span> <span class="o">=</span> <span class="n">determine_qm_software</span><span class="p">(</span><span class="n">fullpath</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">loadGeometry</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="o">=</span> <span class="n">get_xyz_string</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">numbers</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;composite converged; &#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;output.out&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">opt_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span>
            <span class="n">rxn_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">rxn_str</span> <span class="o">=</span> <span class="s1">&#39; of reaction </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Optimized geometry for </span><span class="si">{label}{rxn}</span><span class="s1"> at </span><span class="si">{level}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{xyz}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">rxn</span><span class="o">=</span><span class="n">rxn_str</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for TSs, only use `draw_3d()`, not `show_sticks()` which gets connectivity wrong:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                                       <span class="n">method</span><span class="o">=</span><span class="s1">&#39;draw_3d&#39;</span><span class="p">)</span>
            <span class="c1"># Check frequencies (using cclib crashes for CBS-QB3 output, so using an explicit parser here)</span>
            <span class="n">frequencies</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_frequencies</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">)</span>
            <span class="n">freq_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">vibfreqs</span><span class="o">=</span><span class="n">frequencies</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">freq_ok</span><span class="p">:</span>
                <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># run freq / scan jobs on this optimized geometry</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">check_final_xyz_isomorphism</span><span class="p">(</span>
                        <span class="n">allow_nonisomorphic_2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;composite passed isomorphism check; &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;composite did not pass isomorphism check; &#39;</span>
                    <span class="n">success</span> <span class="o">&amp;=</span> <span class="n">is_isomorphic</span>
                <span class="k">return</span> <span class="n">success</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;done&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">freq_ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;composite&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># return ``False``, so no freq / scan jobs are initiated for this unoptimized geometry</span></div>

<div class="viewcode-block" id="Scheduler.parse_opt_geo"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.parse_opt_geo">[docs]</a>    <span class="k">def</span> <span class="nf">parse_opt_geo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that an &#39;opt&#39; or &#39;optfreq&#39; job converged successfully, and parse the geometry into `final_xyz`.</span>
<span class="sd">        If the job is &#39;optfreq&#39;, also checks (QA) that no imaginary frequencies were assigned for stable species,</span>
<span class="sd">        and that exactly one imaginary frequency was assigned for a TS.</span>
<span class="sd">        Returns ``True`` if the job (or both jobs) converged successfully, ``False`` otherwise and troubleshoots opt.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;parsing opt geo for </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="n">log</span> <span class="o">=</span> <span class="n">determine_qm_software</span><span class="p">(</span><span class="n">fullpath</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
            <span class="n">coords</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">loadGeometry</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="o">=</span> <span class="n">get_xyz_string</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span> <span class="n">numbers</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">fine</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;molpro&#39;</span><span class="p">:</span>
                <span class="c1"># Run opt again using a finer grid.</span>
                <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">xyz</span>  <span class="c1"># save for troubleshooting, since trsh goes by initial</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s1">&#39;optfreq&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_freq_job</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;opt converged; &#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">opt_level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">save_geo</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                    <span class="n">rxn_str</span> <span class="o">=</span> <span class="s1">&#39; of reaction </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rxn_label</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rxn_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
                    <span class="c1"># This is the final geometry of a stable species. Determine whether the species participates in</span>
                    <span class="c1"># a reaction (or several), if so update its geometry in the respective Species representing the</span>
                    <span class="c1"># reaction&#39;s TS</span>
                    <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxn_list</span><span class="p">:</span>
                        <span class="n">reactant</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">reactants</span> <span class="k">else</span> <span class="kc">False</span>
                        <span class="n">product</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">products</span> <span class="k">else</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">reactant</span> <span class="ow">or</span> <span class="n">product</span><span class="p">:</span>
                            <span class="n">ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">ts_label</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">tsg</span> <span class="ow">in</span> <span class="n">ts</span><span class="o">.</span><span class="n">ts_guesses</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">reactant</span> <span class="ow">and</span>\
                                        <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">reactant_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span> <span class="k">for</span> <span class="n">reactant_xyz</span> <span class="ow">in</span> <span class="n">tsg</span><span class="o">.</span><span class="n">reactants_xyz</span><span class="p">]):</span>
                                    <span class="c1"># This species is a reactant of rxn,</span>
                                    <span class="c1"># and its geometry wasn&#39;t saved in the TSGuess objects</span>
                                    <span class="n">tsg</span><span class="o">.</span><span class="n">reactants_xyz</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">product</span> <span class="ow">and</span>\
                                        <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">product_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span> <span class="k">for</span> <span class="n">product_xyz</span> <span class="ow">in</span> <span class="n">tsg</span><span class="o">.</span><span class="n">products_xyz</span><span class="p">]):</span>
                                    <span class="c1"># This species is a product of rxn,</span>
                                    <span class="c1"># and its geometry wasn&#39;t saved in the TSGuess objects</span>
                                    <span class="n">tsg</span><span class="o">.</span><span class="n">products_xyz</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Optimized geometry for </span><span class="si">{label}{rxn}</span><span class="s1"> at </span><span class="si">{level}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{xyz}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">rxn</span><span class="o">=</span><span class="n">rxn_str</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>  <span class="c1"># will be overwritten when freq is done</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for TSs, only use `draw_3d()`, not `show_sticks()` which gets connectivity wrong:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">project_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span>
                                       <span class="n">method</span><span class="o">=</span><span class="s1">&#39;draw_3d&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">is_isomorphic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">check_final_xyz_isomorphism</span><span class="p">(</span>
                    <span class="n">allow_nonisomorphic_2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_nonisomorphic_2d</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_isomorphic</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;opt passed isomorphism check; &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;opt did not pass isomorphism check; &#39;</span>
                <span class="n">success</span> <span class="o">&amp;=</span> <span class="n">is_isomorphic</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_opt_jobs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># run freq / sp / scan jobs on this optimized geometry</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># return ``False``, so no freq / sp / scan jobs are initiated for this unoptimized geometry</span></div>

<div class="viewcode-block" id="Scheduler.check_freq_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_freq_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_freq_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a freq job converged successfully. Also checks (QA) that no imaginary frequencies were assigned for</span>
<span class="sd">        stable species, and that exactly one imaginary frequency was assigned for a TS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Called check_freq_job with no output file&#39;</span><span class="p">)</span>
            <span class="n">vibfreqs</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_frequencies</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">),</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">)</span>
            <span class="n">freq_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">vibfreqs</span><span class="o">=</span><span class="n">vibfreqs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">freq_ok</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_negative_freq</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">freq_ok</span><span class="p">:</span>
                <span class="c1"># copy the frequency file to the species / TS output folder</span>
                <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;rxns&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
                <span class="n">freq_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="s1">&#39;freq.out&#39;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="n">freq_path</span><span class="p">)</span>
                <span class="c1"># set species.polarizability</span>
                <span class="n">polarizability</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_polarizability</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">polarizability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">transport_data</span><span class="o">.</span><span class="n">polarizability</span> <span class="o">=</span> <span class="p">(</span><span class="n">polarizability</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;angstroms^3&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">transport_data</span><span class="o">.</span><span class="n">comment</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">transport_data</span><span class="o">.</span><span class="n">comment</span> <span class="o">+=</span>\
                            <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Polarizability calculated at the </span><span class="si">{0}</span><span class="s1"> level of theory&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">transport_data</span><span class="o">.</span><span class="n">comment</span> <span class="o">=</span>\
                            <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Polarizability calculated at the </span><span class="si">{0}</span><span class="s1"> level of theory&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_level</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;freq&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.check_negative_freq"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_negative_freq">[docs]</a>    <span class="k">def</span> <span class="nf">check_negative_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">vibfreqs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A helper function for determining the number of negative frequencies. Also logs appropriate errors.</span>
<span class="sd">        Returns ``True`` if the number of negative frequencies is as excepted, ``False`` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">neg_freq_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">neg_fre</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">vibfreqs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">neg_freq_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">neg_fre</span> <span class="o">=</span> <span class="n">freq</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="n">neg_freq_counter</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;TS </span><span class="si">{0}</span><span class="s1"> has </span><span class="si">{1}</span><span class="s1"> imaginary frequencies,&#39;</span>
                         <span class="s1">&#39; should have exactly 1.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">neg_freq_counter</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Warning: </span><span class="si">{0}</span><span class="s1"> imaginary freq for TS; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">neg_freq_counter</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">and</span> <span class="n">neg_freq_counter</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Species </span><span class="si">{0}</span><span class="s1"> has </span><span class="si">{1}</span><span class="s1"> imaginary frequencies,&#39;</span>
                         <span class="s1">&#39; should have exactly 0.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">neg_freq_counter</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;Warning: </span><span class="si">{0}</span><span class="s1"> imaginary freq for stable species; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">neg_freq_counter</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> has exactly one imaginary frequency: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">neg_fre</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;freq converged; &#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">testing</span><span class="p">:</span>
                <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Scheduler.check_sp_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_sp_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_sp_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a single point job converged successfully.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;mrci&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sp_level</span> <span class="ow">and</span> <span class="s1">&#39;mrci&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">:</span>
            <span class="c1"># This is a CCSD job ran before MRCI. Spawn MRCI</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_sp_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;sp converged; &#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path</span><span class="p">,</span> <span class="s1">&#39;output.out&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_t1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">])</span>
            <span class="n">zpe_scale_factor</span> <span class="o">=</span> <span class="mf">0.99</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;cbs-qb3&#39;</span> <span class="k">else</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">e_elect</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_e_elect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;sp&#39;</span><span class="p">],</span>
                                                                    <span class="n">zpe_scale_factor</span><span class="o">=</span><span class="n">zpe_scale_factor</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">:</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;. Looks like it requires multireference treatment, I wouldn&#39;t trust it&#39;s calculated energy!&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;T1 = </span><span class="si">{0}</span><span class="s1">; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span> <span class="o">&gt;</span> <span class="mf">0.015</span><span class="p">:</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="s2">&quot;. It might have multireference characteristic.&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;T1 = </span><span class="si">{0}</span><span class="s1">; &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Species </span><span class="si">{0}</span><span class="s1"> has a T1 diagnostic parameter of </span><span class="si">{1}{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="n">txt</span><span class="p">))</span>
            <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># save the geometry from the sp job for monoatomic species for which no opt/freq jobs will be spawned</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;geo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;sp&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.check_scan_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_scan_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_scan_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that a rotor scan job converged successfully. Also checks (QA) whether the scan is relatively &quot;smooth&quot;,</span>
<span class="sd">        and whether the optimized geometry indeed represents the minimum energy conformer.</span>
<span class="sd">        Recommends whether or not to use this rotor using the &#39;successful_rotors&#39; and &#39;unsuccessful_rotors&#39; attributes.</span>

<span class="sd">        rotors_dict structure (attribute of ARCSpecies)::</span>

<span class="sd">            rotors_dict: {1: {&#39;pivots&#39;: pivots_list,</span>
<span class="sd">                              &#39;top&#39;: top_list,</span>
<span class="sd">                              &#39;scan&#39;: scan_list,</span>
<span class="sd">                              &#39;success&#39;: ``bool``,</span>
<span class="sd">                              &#39;invalidation_reason&#39;: ``str``,</span>
<span class="sd">                              &#39;times_dihedral_set&#39;: ``int``,</span>
<span class="sd">                              &#39;scan_path&#39;: &lt;path to scan output file&gt;,</span>
<span class="sd">                              &#39;max_e&#39;: ``float``,  # in kJ/mol},</span>
<span class="sd">                              &#39;symmetry&#39;: ``int``}</span>
<span class="sd">                          2: {}, ...</span>
<span class="sd">                         }</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_rotors</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">trsh</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">:</span>
                <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                    <span class="c1"># ESS converged. Get PES scan using Arkane:</span>
                    <span class="n">log</span> <span class="o">=</span> <span class="n">determine_qm_software</span><span class="p">(</span><span class="n">fullpath</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">v_list</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">loadScanEnergies</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Energies from rotor scan of </span><span class="si">{label}</span><span class="s1"> between pivots </span><span class="si">{pivots}</span><span class="s1"> could not&#39;</span>
                                     <span class="s1">&#39;be read. Invalidating rotor.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">))</span>
                        <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="s1">&#39;could not read energies&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">v_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v_list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                        <span class="n">v_list</span> <span class="o">*=</span> <span class="mf">0.001</span>  <span class="c1"># convert to kJ/mol</span>
                        <span class="c1"># 1. Check smoothness:</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">v_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">inconsistency_az</span><span class="p">:</span>
                            <span class="c1"># initial and final points differ by more than `inconsistency_az` kJ/mol.</span>
                            <span class="c1"># seems like this rotor broke the conformer. Invalidate</span>
                            <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;Rotor scan of </span><span class="si">{label}</span><span class="s1"> between pivots </span><span class="si">{pivots}</span><span class="s1"> is inconsistent by more&#39;</span> \
                                            <span class="s1">&#39; than </span><span class="si">{incons_az:.2f}</span><span class="s1"> kJ/mol between initial and final positions.&#39;</span> \
                                            <span class="s1">&#39; Invalidating rotor.</span><span class="se">\n</span><span class="s1">v_list[0] = </span><span class="si">{v0}</span><span class="s1">, v_list[-1] = </span><span class="si">{vneg1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                             <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">incons_az</span><span class="o">=</span><span class="n">inconsistency_az</span><span class="p">,</span>
                                             <span class="n">v0</span><span class="o">=</span><span class="n">v_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vneg1</span><span class="o">=</span><span class="n">v_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
                            <span class="n">message</span> <span class="o">+=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;; &#39;</span>
                            <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="s1">&#39;initial and final points are inconsistent by more than </span><span class="si">{0:.2f}</span><span class="s1"> &#39;</span> \
                                                  <span class="s1">&#39;kJ/mol&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inconsistency_az</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">scan_trsh</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Trying to troubleshoot rotor </span><span class="si">{0}</span><span class="s1"> of </span><span class="si">{1}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
                                <span class="n">trsh</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_scan_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;inc_res&#39;</span><span class="p">,</span> <span class="s1">&#39;freeze&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">invalidate</span><span class="p">:</span>
                            <span class="n">v_last</span> <span class="o">=</span> <span class="n">v_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">v_list</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">v_last</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">inconsistency_ab</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">v_list</span><span class="p">):</span>
                                    <span class="c1"># Two consecutive points on the scan differ by more than `inconsistency_ab` kJ/mol.</span>
                                    <span class="c1"># This is a serious inconsistency. Invalidate</span>
                                    <span class="n">error_message</span> <span class="o">=</span> <span class="s1">&#39;Rotor scan of </span><span class="si">{label}</span><span class="s1"> between pivots </span><span class="si">{pivots}</span><span class="s1"> is inconsistent &#39;</span> \
                                                    <span class="s1">&#39;by more than </span><span class="si">{incons_ab:.2f}</span><span class="s1"> kJ/mol between two consecutive &#39;</span> \
                                                    <span class="s1">&#39;points. Invalidating rotor.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                     <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span>
                                                     <span class="n">incons_ab</span><span class="o">=</span><span class="n">inconsistency_ab</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">v_list</span><span class="p">))</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_message</span><span class="p">)</span>
                                    <span class="n">message</span> <span class="o">+=</span> <span class="n">error_message</span> <span class="o">+</span> <span class="s1">&#39;; &#39;</span>
                                    <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="s1">&#39;two consecutive points are inconsistent by more than &#39;</span> \
                                                          <span class="s1">&#39;</span><span class="si">{0:.2f}</span><span class="s1"> kJ/mol&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inconsistency_ab</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">v_list</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">scan_trsh</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Trying to troubleshoot rotor </span><span class="si">{0}</span><span class="s1"> of </span><span class="si">{1}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
                                        <span class="n">trsh</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_scan_job</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;inc_res&#39;</span><span class="p">,</span> <span class="s1">&#39;freeze&#39;</span><span class="p">])</span>
                                    <span class="k">break</span>
                                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">v_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">maximum_barrier</span><span class="p">:</span>
                                    <span class="c1"># The barrier for the hinderd rotor is higher than `maximum_barrier` kJ/mol.</span>
                                    <span class="c1"># Invalidate</span>
                                    <span class="n">warn_message</span> <span class="o">=</span> <span class="s1">&#39;Rotor scan of </span><span class="si">{label}</span><span class="s1"> between pivots </span><span class="si">{pivots}</span><span class="s1"> has a barrier &#39;</span> \
                                                   <span class="s1">&#39;larger than </span><span class="si">{max_barrier:.2f}</span><span class="s1"> kJ/mol. Invalidating rotor.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">max_barrier</span><span class="o">=</span><span class="n">maximum_barrier</span><span class="p">)</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warn_message</span><span class="p">)</span>
                                    <span class="n">message</span> <span class="o">+=</span> <span class="n">warn_message</span> <span class="o">+</span> <span class="s1">&#39;; &#39;</span>
                                    <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="s1">&#39;scan has a barrier larger than </span><span class="si">{0}</span><span class="s1">&#39;</span> \
                                                          <span class="s1">&#39; kJ/mol&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maximum_barrier</span><span class="p">)</span>
                                    <span class="k">break</span>
                                <span class="n">v_last</span> <span class="o">=</span> <span class="n">v</span>
                        <span class="c1"># 2. Check conformation:</span>
                        <span class="n">invalidated</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">invalidate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trsh</span><span class="p">:</span>
                            <span class="n">v_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">v_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v_list</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">v_diff</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">v_diff</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">v_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">v_list</span><span class="p">)):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Species </span><span class="si">{label}</span><span class="s1"> is not oriented correctly around pivots </span><span class="si">{pivots}</span><span class="s1">,&#39;</span>
                                            <span class="s1">&#39; searching for a better conformation...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                                                                             <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">))</span>
                                <span class="c1"># Find the rotation dihedral in degrees to the closest minimum:</span>
                                <span class="n">min_v</span> <span class="o">=</span> <span class="n">v_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">min_index</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v_list</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">min_v</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
                                        <span class="n">min_v</span> <span class="o">=</span> <span class="n">v</span>
                                        <span class="n">min_index</span> <span class="o">=</span> <span class="n">j</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">set_dihedral</span><span class="p">(</span>
                                    <span class="n">pivots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">],</span>
                                    <span class="n">scan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">],</span>
                                    <span class="n">deg_increment</span><span class="o">=</span><span class="n">min_index</span><span class="o">*</span><span class="n">rotor_scan_resolution</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_species_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                                <span class="c1"># Remove all completed rotor calculation information</span>
                                <span class="k">for</span> <span class="n">rotor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                                    <span class="n">rotor</span><span class="p">[</span><span class="s2">&quot;scan_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                    <span class="n">rotor</span><span class="p">[</span><span class="s2">&quot;invalidation_reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                    <span class="n">rotor</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">rotor</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;symmetry&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">run_opt_job</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>  <span class="c1"># run opt on new initial_xyz with the desired dihedral</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">elif</span> <span class="n">invalidate</span><span class="p">:</span>
                            <span class="n">invalidated</span> <span class="o">=</span> <span class="s1">&#39;*INVALIDATED* &#39;</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">determine_rotor_symmetry</span><span class="p">(</span>
                                <span class="n">rotor_path</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                <span class="n">pivots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">symmetry</span> <span class="o">=</span> <span class="s1">&#39; has symmetry </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;symmetry&#39;</span><span class="p">])</span>

                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{invalidated}</span><span class="s1">Rotor scan </span><span class="si">{scan}</span><span class="s1"> between pivots </span><span class="si">{pivots}</span><span class="s1">&#39;</span>
                                        <span class="s1">&#39; for </span><span class="si">{label}{symmetry}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                         <span class="n">invalidated</span><span class="o">=</span><span class="n">invalidated</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">],</span>
                                         <span class="n">pivots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pivots&#39;</span><span class="p">],</span>
                                         <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">symmetry</span><span class="o">=</span><span class="n">symmetry</span><span class="p">))</span>
                            <span class="n">folder_name</span> <span class="o">=</span> <span class="s1">&#39;rxns&#39;</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_ts</span> <span class="k">else</span> <span class="s1">&#39;Species&#39;</span>
                            <span class="n">rotor_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">folder_name</span><span class="p">,</span>
                                                      <span class="n">job</span><span class="o">.</span><span class="n">species_name</span><span class="p">,</span> <span class="s1">&#39;rotors&#39;</span><span class="p">)</span>
                            <span class="n">message</span> <span class="o">+=</span> <span class="n">invalidated</span>
                            <span class="n">plotter</span><span class="o">.</span><span class="n">plot_rotor_scan</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">v_list</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">rotor_path</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># scan job crashed</span>
                    <span class="n">invalidate</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">invalidation_reason</span> <span class="o">=</span> <span class="s1">&#39;scan job crashed&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">trsh</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">invalidate</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;scan_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;invalidation_reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">invalidation_reason</span>
                <span class="k">break</span>  <span class="c1"># A job object has only one pivot. Break if found, otherwise raise an error.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Could not match rotor with pivots </span><span class="si">{0}</span><span class="s1"> in species </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.check_md_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_md_job">[docs]</a>    <span class="k">def</span> <span class="nf">check_md_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the MD spawning algorithm converged on a single structure.</span>
<span class="sd">        If not converged, spawn another MD job (up to a maximum number of jobs).</span>
<span class="sd">        If it did converge, save the resulting lowest conformers and DFT them.</span>

<span class="sd">        Args:</span>
<span class="sd">             label (str): The species label.</span>
<span class="sd">             job (Job): The Gromacs MD job to check.</span>
<span class="sd">             max_iterations (int, optional): The maximal number of MD trials per species.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">conf_list</span> <span class="o">=</span> <span class="n">read_yaml_file</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">)</span>
        <span class="n">lowest_conf</span> <span class="o">=</span> <span class="n">conformers</span><span class="o">.</span><span class="n">get_lowest_confs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="n">conf_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span> <span class="o">=</span> <span class="n">lowest_conf</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">max_iterations</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not converge on a single conformer using Gromacs for species </span><span class="si">{0}</span><span class="s1"> &#39;</span>
                             <span class="s1">&#39;even after </span><span class="si">{1}</span><span class="s1"> iterations. Using the latest conformer.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">max_iterations</span><span class="p">))</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">lowest_conf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># unconverged</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span> <span class="o">=</span> <span class="n">lowest_conf</span>\
                                                               <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">lowest_conf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">conformers</span><span class="o">.</span><span class="n">compare_xyz</span><span class="p">(</span><span class="n">lowest_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="c1"># converged</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># same energy but different conformer? for now we&#39;ll consider it as converged</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;MD jobs for </span><span class="si">{0}</span><span class="s1"> converged with same energy conformer by different xyz:</span><span class="se">\n</span><span class="s1">&#39;</span>
                                   <span class="s1">&#39;</span><span class="si">{1}</span><span class="se">\n\n</span><span class="s1">and</span><span class="se">\n\n</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                              <span class="n">lowest_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Todo: reconsider</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># why did we found a higher conformer?</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not converge on a single conformer using Gromacs for species </span><span class="si">{0}</span><span class="s1">, got a higher&#39;</span>
                             <span class="s1">&#39;energy conformer. Using the latest lowest conformer.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
            <span class="c1"># process conformers and DFT them</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Final conformer for </span><span class="si">{0}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">lowest_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">lowest_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
            <span class="n">lowest_confs</span> <span class="o">=</span> <span class="n">conformers</span><span class="o">.</span><span class="n">get_lowest_confs</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">confs</span><span class="o">=</span><span class="n">conf_list</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">confs_to_dft</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">standardize_xyz_string</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">conf</span> <span class="ow">in</span> <span class="n">lowest_confs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lowest_confs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_conformers</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># spawn a new MD simulation</span>
            <span class="n">ordinal</span> <span class="o">=</span> <span class="n">get_ordinal_indicator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}{1}</span><span class="s1"> conformer for </span><span class="si">{2}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                                <span class="n">ordinal</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">lowest_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">draw_structure</span><span class="p">(</span><span class="n">xyz</span><span class="o">=</span><span class="n">lowest_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">species</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
            <span class="n">ordinal</span> <span class="o">=</span> <span class="n">get_ordinal_indicator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Spawning the </span><span class="si">{0}{1}</span><span class="s1"> round of MD simulations for </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">recent_md_conformer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ordinal</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spawn_md_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">prev_conf_list</span><span class="o">=</span><span class="n">conf_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.check_all_done"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.check_all_done">[docs]</a>    <span class="k">def</span> <span class="nf">check_all_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that we have all required data for the species/TS in ``label``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">status</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;composite converged&#39;</span> <span class="ow">in</span> <span class="n">status</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;sp converged&#39;</span> <span class="ow">in</span> <span class="n">status</span> <span class="ow">and</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">number_of_atoms</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span>
                <span class="p">(</span><span class="s1">&#39;freq converged&#39;</span> <span class="ow">in</span> <span class="n">status</span> <span class="ow">and</span> <span class="s1">&#39;opt converged&#39;</span> <span class="ow">in</span> <span class="n">status</span><span class="p">)))):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;ALL converged&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">is_ts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">make_ts_report</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">ts_report</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">zero_delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">conf_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>\
                <span class="k">if</span> <span class="s1">&#39;conformers&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="n">opt_time</span> <span class="o">=</span> <span class="n">sum_time_delta</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>\
                <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="n">comp_time</span> <span class="o">=</span> <span class="n">sum_time_delta</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;composite&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>\
                <span class="k">if</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="n">other_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">sum_time_delta</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">run_time</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">job_dictionary</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
                              <span class="k">for</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">job_dictionary</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                              <span class="k">if</span> <span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]])</span>\
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">job_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conformers&#39;</span><span class="p">,</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span> <span class="k">else</span> <span class="n">zero_delta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">run_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">run_time</span>\
                                                <span class="ow">or</span> <span class="p">(</span><span class="n">conf_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">opt_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span>\
                                                <span class="o">+</span> <span class="p">(</span><span class="n">comp_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">other_time</span> <span class="ow">or</span> <span class="n">zero_delta</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">All jobs for species </span><span class="si">{0}</span><span class="s1"> successfully converged.&#39;</span>
                        <span class="s1">&#39; Run time: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">run_time</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nothing converged&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Species </span><span class="si">{0}</span><span class="s1"> did not converge. Status is: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
        <span class="c1"># Update restart dictionary and save the yaml restart file:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.get_servers_jobs_ids"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.get_servers_jobs_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_servers_jobs_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check status on all active servers, return a list of relevant running job IDs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">server</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">server</span> <span class="o">!=</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
                <span class="n">ssh</span> <span class="o">=</span> <span class="n">SSHClient</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ssh</span><span class="o">.</span><span class="n">check_running_jobs_ids</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">check_running_jobs_ids</span><span class="p">())</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_negative_freq"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_negative_freq">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_negative_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshooting cases where stable species (not TS&#39;s) have negative frequencies.</span>
<span class="sd">        We take  +/-1.1 displacements, generating several initial geometries, and running them as conformers</span>

<span class="sd">        Todo:</span>
<span class="sd">            * get all torsions of the molecule (if weren&#39;t already generated),</span>
<span class="sd">              identify atom/s with largest displacements (top 2)</span>
<span class="sd">              determine torsions with unique PIVOTS where these atoms are in the &quot;scan&quot; and &quot;top&quot; but not pivotal</span>
<span class="sd">              generate a 360 scal using 30 deg increments and append all 12 results as conformers</span>
<span class="sd">              (consider rotor symmetry to append less conformers?)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.1</span>
        <span class="n">ccparser</span> <span class="o">=</span> <span class="n">cclib</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">ccopen</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">local_path_to_output_file</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ccparser</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="n">vibfreqs</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">vibfreqs</span>
        <span class="n">vibdisps</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">vibdisps</span>
        <span class="n">atomnos</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomnos</span>
        <span class="n">atomcoords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">atomcoords</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">neg_freqs_trshed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Species </span><span class="si">{0}</span><span class="s1"> was troubleshooted for negative frequencies too many times.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_types</span><span class="p">[</span><span class="s1">&#39;1d_rotors&#39;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;The rotor scans feature is turned off, &#39;</span>
                             <span class="s1">&#39;cannot troubleshoot geometry using dihedral modifications.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1d_rotors = False; &#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Invalidating species.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Error: Encountered negative frequencies too many times; &#39;</span>
            <span class="k">return</span>
        <span class="n">neg_freqs_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># store indices w.r.t. vibfreqs</span>
        <span class="n">largest_neg_freq_idx</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># index in vibfreqs</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vibfreqs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">neg_freqs_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">vibfreqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">vibfreqs</span><span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]:</span>
                    <span class="n">largest_neg_freq_idx</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># assuming frequencies are ordered, break after the first positive freq encounter</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">vibfreqs</span><span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Could not determine negative frequency in species </span><span class="si">{0}</span><span class="s1"> while troubleshooting for&#39;</span>
                                 <span class="s1">&#39; negative frequencies&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">neg_freqs_trshed</span><span class="p">):</span>
            <span class="c1"># species has one negative frequency, and has not been troubleshooted for it before</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Species </span><span class="si">{0}</span><span class="s1"> has a negative frequency (</span><span class="si">{1}</span><span class="s1">). Perturbing its geometry using the respective &#39;</span>
                        <span class="s1">&#39;vibrational displacements&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">vibfreqs</span><span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]))</span>
            <span class="n">neg_freqs_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]</span>  <span class="c1"># indices of the negative frequencies to troubleshoot for</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">neg_freqs_trshed</span><span class="p">):</span>
            <span class="c1"># species has one negative frequency, and has been troubleshooted for it before</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">neg_freqs_trshed</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Species </span><span class="si">{0}</span><span class="s1"> has a negative frequency (</span><span class="si">{1}</span><span class="s1">) for the </span><span class="si">{2}</span><span class="s1"> time. Perturbing its geometry using &#39;</span>
                        <span class="s1">&#39;the respective vibrational displacements, this time using a larger factor (x </span><span class="si">{3}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                         <span class="n">label</span><span class="p">,</span> <span class="n">vibfreqs</span><span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">neg_freqs_trshed</span><span class="p">),</span> <span class="n">factor</span><span class="p">))</span>
            <span class="n">neg_freqs_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]</span>  <span class="c1"># indices of the negative frequencies to troubleshoot for</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">neg_freqs_trshed</span><span class="p">):</span>
            <span class="c1"># species has more than one negative frequency, and has not been troubleshooted for it before</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Species </span><span class="si">{0}</span><span class="s1"> has </span><span class="si">{1}</span><span class="s1"> negative frequencies. Perturbing its geometry using the vibrational &#39;</span>
                        <span class="s1">&#39;displacements of its largest negative frequency, </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">),</span>
                                                                                      <span class="n">vibfreqs</span><span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]))</span>
            <span class="n">neg_freqs_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">largest_neg_freq_idx</span><span class="p">]</span>  <span class="c1"># indices of the negative frequencies to troubleshoot for</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">neg_freqs_trshed</span><span class="p">):</span>
            <span class="c1"># species has more than one negative frequency, and has been troubleshooted for it before</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Species </span><span class="si">{0}</span><span class="s1"> has </span><span class="si">{1}</span><span class="s1"> negative frequencies. Perturbing its geometry using the vibrational&#39;</span>
                        <span class="s1">&#39; displacements of ALL negative frequencies&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">neg_freqs_idx</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">neg_freqs_trshed</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">round</span><span class="p">(</span><span class="n">vibfreqs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">neg_freqs_idx</span><span class="p">])</span>  <span class="c1"># record freqs</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting all currently running jobs for species </span><span class="si">{0}</span><span class="s1"> before troubleshooting for&#39;</span>
                    <span class="s1">&#39; negative frequency...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_all_species_jobs</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># initialize the conformer list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">atomcoords</span> <span class="o">=</span> <span class="n">atomcoords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># it&#39;s a list within a list, take the last geometry</span>
        <span class="k">for</span> <span class="n">neg_freq_idx</span> <span class="ow">in</span> <span class="n">neg_freqs_idx</span><span class="p">:</span>
            <span class="n">displacement</span> <span class="o">=</span> <span class="n">vibdisps</span><span class="p">[</span><span class="n">neg_freq_idx</span><span class="p">]</span>
            <span class="n">xyz1</span> <span class="o">=</span> <span class="n">atomcoords</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">displacement</span>
            <span class="n">xyz2</span> <span class="o">=</span> <span class="n">atomcoords</span> <span class="o">-</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">displacement</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_xyz_string</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">xyz1</span><span class="p">,</span> <span class="n">numbers</span><span class="o">=</span><span class="n">atomnos</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_xyz_string</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">xyz2</span><span class="p">,</span> <span class="n">numbers</span><span class="o">=</span><span class="n">atomnos</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_energies</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>  <span class="c1"># a placeholder (lists are synced)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># initialize the conformer job dictionary</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conformer_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;conformer&#39;</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">i</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_scan_job"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_scan_job">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_scan_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshooting rotor scans</span>
<span class="sd">        Using the following methods: freezing all dihedrals other than the scan&#39;s pivots for this job,</span>
<span class="sd">        or increasing the scan resolution.</span>

<span class="sd">        Args:</span>
<span class="sd">            job (Job): The scan Job object.</span>
<span class="sd">            method (list): The troubleshooting method/s to try.</span>
<span class="sd">                           Optional values: &#39;freeze&#39;, &#39;inc_res&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Called troubleshoot_scan_job() with no method&#39;</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">species_name</span>
        <span class="k">if</span> <span class="s1">&#39;troubleshoot_scan_job&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Will not troubleshoot a rotor scan for </span><span class="si">{0}</span><span class="s1"> more than once.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scan_trsh</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;freeze&#39;</span> <span class="ow">in</span> <span class="n">method</span><span class="p">:</span>
                <span class="n">species_scan_lists</span> <span class="o">=</span> <span class="p">[</span><span class="n">rotor_dict</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rotor_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">rotors_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">scan</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">species_scan_lists</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Could not find the dihedral to troubleshoot for in the dcan list of species&#39;</span>
                                         <span class="s1">&#39; </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
                <span class="n">species_scan_lists</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">species_scan_lists</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">scan</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">species_scan_lists</span><span class="p">):</span>
                    <span class="n">scan_trsh</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">species_scan_lists</span><span class="p">:</span>
                        <span class="n">scan_trsh</span> <span class="o">+=</span> <span class="s1">&#39;D &#39;</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">scan</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;F</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;inc_res&#39;</span> <span class="ow">in</span> <span class="n">method</span><span class="p">:</span>
                <span class="n">scan_res</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">scan_res</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
                <span class="c1"># make sure mod(360, scan res) is 0:</span>
                <span class="k">if</span> <span class="n">scan_res</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="n">scan_res</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">scan_res</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scan_res</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">scan_res</span>
            <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;troubleshoot_scan_job&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span>
                         <span class="n">scan</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">scan</span><span class="p">,</span> <span class="n">pivots</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">pivots</span><span class="p">,</span> <span class="n">scan_trsh</span><span class="o">=</span><span class="n">scan_trsh</span><span class="p">,</span> <span class="n">scan_res</span><span class="o">=</span><span class="n">scan_res</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_opt_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_opt_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_opt_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We&#39;re troubleshooting for opt jobs.</span>
<span class="sd">        First check for server status and troubleshoot if needed. Then check for ESS status and troubleshoot</span>
<span class="sd">        if needed. Finally, check whether or not the last job had fine=True, add if it didn&#39;t run with fine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">previous_job_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">latest_job_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">job</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># get latest Job object for the species / TS</span>
            <span class="n">job_name_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="p">[</span><span class="mi">5</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">job_name_int</span> <span class="o">&gt;</span> <span class="n">latest_job_num</span><span class="p">:</span>
                <span class="n">previous_job_num</span> <span class="o">=</span> <span class="n">latest_job_num</span>
                <span class="n">latest_job_num</span> <span class="o">=</span> <span class="n">job_name_int</span>
                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="c1"># run_opt_job should not be called if all looks good...</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;opt job for </span><span class="si">{label}</span><span class="s1"> seems right, yet &quot;run_opt_job&quot;&#39;</span>
                                 <span class="s1">&#39; was called.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;opt job for </span><span class="si">{label}</span><span class="s1"> seems right, yet &quot;run_opt_job&quot;&#39;</span>
                                         <span class="s1">&#39; was called.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Run opt again using a finer grid.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parse_opt_geo</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">)</span>
                    <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span> <span class="o">=</span> <span class="n">xyz</span>  <span class="c1"># save for troubleshooting, since trsh goes by initial</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># job passed on the server, but failed in ESS calculation</span>
                <span class="k">if</span> <span class="n">previous_job_num</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                    <span class="n">previous_job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;opt&#39;</span><span class="p">][</span><span class="s1">&#39;opt_a&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">previous_job_num</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_job</span><span class="o">.</span><span class="n">fine</span> <span class="ow">and</span> <span class="n">previous_job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span> \
                            <span class="ow">and</span> <span class="n">previous_job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
                        <span class="c1"># The present job with a fine grid failed in the ESS calculation.</span>
                        <span class="c1"># A *previous* job without a fine grid terminated successfully on the server and ESS.</span>
                        <span class="c1"># So use the xyz determined w/o the fine grid, and output an error message to alert users.</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Optimization job for </span><span class="si">{label}</span><span class="s1"> with a fine grid terminated successfully&#39;</span>
                                     <span class="s1">&#39; on the server, but crashed during calculation. NOT running with fine&#39;</span>
                                     <span class="s1">&#39; grid again.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">parse_opt_geo</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">previous_job</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">troubleshoot_ess</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">opt_level</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;opt&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">troubleshoot_server</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.troubleshoot_ess"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.troubleshoot_ess">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_ess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Troubleshoot issues related to the electronic structure software, such as conversion</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{label}</span><span class="s1"> job </span><span class="si">{job_name}</span><span class="s1"> which failed with status &quot;</span><span class="si">{stat}</span><span class="s1">&quot; in </span><span class="si">{soft}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">job_name</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">soft</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">conformer</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformers</span><span class="p">[</span><span class="n">conformer</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">final_xyz</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">initial_xyz</span>
        <span class="k">if</span> <span class="s1">&#39;Unknown reason&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;change_node&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;change_node&#39;</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">troubleshoot_server</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">job_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_name</span><span class="p">)</span>  <span class="c1"># mark as a running job</span>
        <span class="k">elif</span> <span class="s1">&#39;Ran out of disk space&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;; Error: Could not troubleshoot </span><span class="si">{job_type}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">! &#39;</span> \
                                            <span class="s1">&#39; The job ran out of disc space on </span><span class="si">{server}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not troubleshoot </span><span class="si">{job_type}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">! The job ran out of disc space on &#39;</span>
                         <span class="s1">&#39;</span><span class="si">{server}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                                           <span class="n">server</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">server</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">checkfile</span>
            <span class="k">if</span> <span class="s1">&#39;Basis set data is not on the checkpoint file&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>\
                    <span class="ow">and</span> <span class="s1">&#39;checkfie=None&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># The checkfile doesn&#39;t match the new basis set, remove it and rerun the job</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> that failed with &#39;</span>
                            <span class="s1">&#39;&quot;Basis set data is not on the checkpoint file&quot; by removing the checkfile.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                             <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;checkfie=None&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">checkfile</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">conformer_checkfiles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;l103 internal coordinate error&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>\
                    <span class="ow">and</span> <span class="s1">&#39;cartesian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span> <span class="ow">and</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;opt&#39;</span><span class="p">:</span>
                <span class="c1"># try both cartesian and nosymm</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using opt=cartesian with&#39;</span>
                            <span class="s1">&#39; nosyym&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cartesian&#39;</span><span class="p">)</span>
                <span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;opt=(cartesian,nosymm)&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;unconverged&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;fine&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">:</span>
                <span class="c1"># try a fine grid for SCF and integral</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using a fine grid&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fine&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;scf=(qc,nosymm)&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># try both qc and nosymm</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using scf=(qc,nosymm)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scf=(qc,nosymm)&#39;</span><span class="p">)</span>
                <span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;scf=(qc,nosymm)&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;scf=(NDump=30)&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># Allows dynamic dumping for up to N SCF iterations (slower conversion)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using scf=(NDump=30)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scf=(NDump=30)&#39;</span><span class="p">)</span>
                <span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;scf=(NDump=30)&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;scf=NoDIIS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># Switching off Pulay&#39;s Direct Inversion</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using scf=NoDIIS&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scf=NoDIIS&#39;</span><span class="p">)</span>
                <span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;scf=NoDIIS&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;int=(Acc2E=14)&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>  <span class="c1"># does not work in g03</span>
                <span class="c1"># Change integral accuracy (skip everything up to 1E-14 instead of 1E-12)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using int=(Acc2E=14)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;int=(Acc2E=14)&#39;</span><span class="p">)</span>
                <span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;int=(Acc2E=14)&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;cbs-qb3&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> <span class="o">!=</span> <span class="s1">&#39;cbs-qb3&#39;</span><span class="p">:</span>
                <span class="c1"># try running CBS-QB3, which is relatively robust</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using CBS-QB3&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cbs-qb3&#39;</span><span class="p">)</span>
                <span class="n">level_of_theory</span> <span class="o">=</span> <span class="s1">&#39;cbs-qb3&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="s1">&#39;composite&#39;</span><span class="p">,</span>
                             <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;scf=nosymm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># try running w/o considering symmetry</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using scf=nosymm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scf=nosymm&#39;</span><span class="p">)</span>
                <span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;scf=nosymm&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;memory&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># Increase memory allocation</span>
                <span class="n">max_mem</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">server</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>  <span class="c1"># Node memory in GB, default to 128 if not specified</span>
                <span class="n">memory</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">memory_gb</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">memory_gb</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">max_mem</span> <span class="o">*</span> <span class="mf">0.9</span> <span class="k">else</span> <span class="n">max_mem</span> <span class="o">*</span> <span class="mf">0.9</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using memory: </span><span class="si">{mem}</span><span class="s1"> GB instead of&#39;</span>
                            <span class="s1">&#39; </span><span class="si">{old}</span><span class="s1"> GB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">mem</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">memory_gb</span><span class="p">,</span>
                                               <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">composite_method</span> <span class="o">!=</span> <span class="s1">&#39;cbs-qb3&#39;</span> <span class="ow">and</span> <span class="s1">&#39;scf=(qc,nosymm) &amp; CBS-QB3&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># try both qc and nosymm with CBS-QB3</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using scf=(qc,nosymm) with &#39;</span>
                            <span class="s1">&#39;CBS-QB3&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scf=(qc,nosymm) &amp; CBS-QB3&#39;</span><span class="p">)</span>
                <span class="n">level_of_theory</span> <span class="o">=</span> <span class="s1">&#39;cbs-qb3&#39;</span>
                <span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;scf=(qc,nosymm)&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;composite&#39;</span> <span class="ow">and</span>\
                    <span class="s1">&#39;qchem&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ess</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
                <span class="c1"># Try QChem</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job using qchem instead of </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;qchem&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span>
                             <span class="n">software</span><span class="o">=</span><span class="s1">&#39;qchem&#39;</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;composite&#39;</span> \
                    <span class="ow">and</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ess</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
                <span class="c1"># Try molpro</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job using molpro instead of </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;molpro&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span>
                             <span class="n">software</span><span class="o">=</span><span class="s1">&#39;molpro&#39;</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not troubleshoot geometry optimization for </span><span class="si">{label}</span><span class="s1">! Tried&#39;</span>
                             <span class="s1">&#39; troubleshooting with the following methods: </span><span class="si">{methods}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;; Error: Could not troubleshoot </span><span class="si">{job_type}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">! &#39;</span> \
                                                <span class="s1">&#39; Tried troubleshooting with the following methods: </span><span class="si">{methods}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">software</span> <span class="o">==</span> <span class="s1">&#39;qchem&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;max opt cycles reached&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;max_cycles&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># this is a common error, increase max cycles and continue running from last geometry</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using max_cycles&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;max_cycles&#39;</span><span class="p">)</span>
                <span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   GEOM_OPT_MAX_CYCLES 250&#39;</span>  <span class="c1"># default is 50</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;SCF failed&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;DIIS_GDM&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># change the SCF algorithm and increase max SCF cycles</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using the DIIS_GDM SCF algorithm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;DIIS_GDM&#39;</span><span class="p">)</span>
                <span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   SCF_ALGORITHM DIIS_GDM</span><span class="se">\n</span><span class="s1">   MAX_SCF_CYCLES 1000&#39;</span>  <span class="c1"># default is 50</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;SYM_IGNORE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>  <span class="c1"># symmetry - look in manual, no symm if fails</span>
                <span class="c1"># change the SCF algorithm and increase max SCF cycles</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using SYM_IGNORE as well as the &#39;</span>
                            <span class="s1">&#39;DIIS_GDM SCF algorithm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;SYM_IGNORE&#39;</span><span class="p">)</span>
                <span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   SCF_ALGORITHM DIIS_GDM</span><span class="se">\n</span><span class="s1">   MAX_SCF_CYCLES 250</span><span class="se">\n</span><span class="s1">   SYM_IGNORE     True&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;b3lyp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using b3lyp&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;b3lyp&#39;</span><span class="p">)</span>
                <span class="c1"># try converging with B3LYP</span>
                <span class="n">level_of_theory</span> <span class="o">=</span> <span class="s1">&#39;b3lyp/6-311++g(d,p)&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span>\
                    <span class="ow">and</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ess</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
                <span class="c1"># Try Gaussian</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job using gaussian instead of </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span>
                             <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span> \
                    <span class="ow">and</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ess</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
                <span class="c1"># Try molpro</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job using molpro instead of </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;molpro&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span>
                             <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="s1">&#39;molpro&#39;</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not troubleshoot geometry optimization for </span><span class="si">{label}</span><span class="s1">! Tried&#39;</span>
                             <span class="s1">&#39; troubleshooting with the following methods: </span><span class="si">{methods}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;; Error: Could not troubleshoot </span><span class="si">{job_type}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">! &#39;</span> \
                                                <span class="s1">&#39; Tried troubleshooting with the following methods: </span><span class="si">{methods}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span>
        <span class="k">elif</span> <span class="s1">&#39;molpro&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;additional memory (mW) required&#39;</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># Increase memory allocation.</span>
                <span class="c1"># job.job_status[1] will be for example `&#39;errored: additional memory (mW) required: 996.31&#39;`.</span>
                <span class="c1"># The number is the ADDITIONAL memory required</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">)</span>
                <span class="n">add_mem</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># parse Molpro&#39;s requirement in MW</span>
                <span class="n">add_mem</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">add_mem</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># round up to the next hundred</span>
                <span class="n">memory</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">memory_gb</span> <span class="o">+</span> <span class="n">add_mem</span> <span class="o">/</span> <span class="mf">128.</span> <span class="o">+</span> <span class="mi">5</span>  <span class="c1"># convert MW to GB, add 5 extra GB (be conservative)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using memory: </span><span class="si">{mem}</span><span class="s1"> GB instead of &#39;</span>
                            <span class="s1">&#39;</span><span class="si">{old}</span><span class="s1"> GB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">mem</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">memory_gb</span><span class="p">,</span>
                                              <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                             <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;shift&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># try adding a level shift for alpha- and beta-spin orbitals</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using shift&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;shift&#39;</span><span class="p">)</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="s1">&#39;shift,-1.0,-0.5;&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;vdz&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># degrade the basis set</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using vdz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;vdz&#39;</span><span class="p">)</span>
                <span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;vdz&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;vdz &amp; shift&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># try adding a level shift for alpha- and beta-spin orbitals</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using vdz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;vdz &amp; shift&#39;</span><span class="p">)</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="s1">&#39;shift,-1.0,-0.5;&#39;</span>
                <span class="n">trsh</span> <span class="o">=</span> <span class="s1">&#39;vdz&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">trsh</span><span class="o">=</span><span class="n">trsh</span><span class="p">,</span>
                             <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;memory&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">:</span>
                <span class="c1"># Increase memory allocation, also run with a shift</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">)</span>
                <span class="n">memory</span> <span class="o">=</span> <span class="n">servers</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">server</span><span class="p">][</span><span class="s1">&#39;memory&#39;</span><span class="p">]</span>  <span class="c1"># set memory to the value of an entire node (in GB)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job in </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1"> using memory: </span><span class="si">{mem}</span><span class="s1"> GB instead of &#39;</span>
                            <span class="s1">&#39;</span><span class="si">{old}</span><span class="s1"> GB&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">mem</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">memory_gb</span><span class="p">,</span>
                                              <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="s1">&#39;shift,-1.0,-0.5;&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
                             <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">memory</span><span class="p">,</span>
                             <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span>\
                    <span class="ow">and</span> <span class="s1">&#39;gaussian&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ess</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
                <span class="c1"># Try Gaussian</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job using gaussian instead of </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span>
                             <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span>
                             <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span> <span class="ow">and</span> <span class="s1">&#39;qchem&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ess</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ess</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
                <span class="c1"># Try QChem</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Troubleshooting </span><span class="si">{type}</span><span class="s1"> job using qchem instead of </span><span class="si">{software}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">software</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">))</span>
                <span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;qchem&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_job</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">xyz</span><span class="o">=</span><span class="n">xyz</span><span class="p">,</span> <span class="n">level_of_theory</span><span class="o">=</span><span class="n">level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">fine</span><span class="p">,</span>
                             <span class="n">software</span><span class="o">=</span><span class="s1">&#39;qchem&#39;</span><span class="p">,</span> <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">,</span> <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not troubleshoot geometry optimization for </span><span class="si">{label}</span><span class="s1">! Tried&#39;</span>
                             <span class="s1">&#39; troubleshooting with the following methods: </span><span class="si">{methods}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;; Error: Could not troubleshoot </span><span class="si">{job_type}</span><span class="s1"> for </span><span class="si">{label}</span><span class="s1">! &#39;</span> \
                                                <span class="s1">&#39; Tried troubleshooting with the following methods: </span><span class="si">{methods}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">ess_trsh_methods</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_restart_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.delete_all_species_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.delete_all_species_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">delete_all_species_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete all jobs of species/TS represented by `label`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Deleting all jobs for species </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">job_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">job_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Deleted job </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_name</span><span class="p">))</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span></div>

<div class="viewcode-block" id="Scheduler.restore_running_jobs"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.restore_running_jobs">[docs]</a>    <span class="k">def</span> <span class="nf">restore_running_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make Job objects for jobs which were running in the previous session.</span>
<span class="sd">        Important for the restart feature so long jobs won&#39;t be ran twice.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;running_jobs&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">spc_label</span> <span class="ow">in</span> <span class="n">jobs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">spc_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">job_description</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">or</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;conformer</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">species</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="n">spc_label</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Could not find species </span><span class="si">{0}</span><span class="s1"> in the restart file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spc_label</span><span class="p">))</span>
                <span class="n">conformer</span> <span class="o">=</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">ess_settings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ess_settings</span><span class="p">,</span> <span class="n">species_name</span><span class="o">=</span><span class="n">spc_label</span><span class="p">,</span>
                          <span class="n">xyz</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;xyz&#39;</span><span class="p">],</span> <span class="n">job_type</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">],</span>
                          <span class="n">level_of_theory</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;level_of_theory&#39;</span><span class="p">],</span> <span class="n">multiplicity</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">,</span>
                          <span class="n">charge</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">fine</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;fine&#39;</span><span class="p">],</span> <span class="n">shift</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">],</span>
                          <span class="n">is_ts</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">is_ts</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">],</span> <span class="n">trsh</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;trsh&#39;</span><span class="p">],</span>
                          <span class="n">ess_trsh_methods</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;ess_trsh_methods&#39;</span><span class="p">],</span> <span class="n">scan</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">],</span>
                          <span class="n">pivots</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;pivots&#39;</span><span class="p">],</span> <span class="n">occ</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;occ&#39;</span><span class="p">],</span>
                          <span class="n">project_directory</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;project_directory&#39;</span><span class="p">],</span> <span class="n">job_num</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_num&#39;</span><span class="p">],</span>
                          <span class="n">job_server_name</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_server_name&#39;</span><span class="p">],</span> <span class="n">job_name</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">],</span>
                          <span class="n">job_id</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_id&#39;</span><span class="p">],</span> <span class="n">server</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">],</span>
                          <span class="n">initial_time</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;initial_time&#39;</span><span class="p">],</span> <span class="n">conformer</span><span class="o">=</span><span class="n">conformer</span><span class="p">,</span>
                          <span class="n">software</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;software&#39;</span><span class="p">],</span> <span class="n">comments</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">],</span>
                          <span class="n">scan_trsh</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;scan_trsh&#39;</span><span class="p">],</span> <span class="n">initial_trsh</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;initial_trsh&#39;</span><span class="p">],</span>
                          <span class="n">max_job_time</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;max_job_time&#39;</span><span class="p">],</span> <span class="n">scan_res</span><span class="o">=</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;scan_res&#39;</span><span class="p">],</span>
                          <span class="n">number_of_radicals</span><span class="o">=</span><span class="n">species</span><span class="o">.</span><span class="n">number_of_radicals</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">spc_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">or</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="s1">&#39;conformers&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_description</span> <span class="ow">or</span> <span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_type&#39;</span><span class="p">]][</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">job</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">job_description</span><span class="p">[</span><span class="s1">&#39;conformer&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="n">job</span>
                    <span class="c1"># don&#39;t generate additional conformers for this species</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dont_gen_confs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spc_label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">servers_jobs_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="s1">&#39;Restarting ARC, tracking the following jobs spawned in a previous session:&#39;</span>
            <span class="k">for</span> <span class="n">spc_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">spc_label</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span>
                <span class="k">for</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_type</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">job_type</span> <span class="o">!=</span> <span class="s1">&#39;conformers&#39;</span><span class="p">:</span>
                            <span class="n">content</span> <span class="o">+=</span> <span class="n">job_name</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">content</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc_label</span><span class="p">][</span><span class="n">job_type</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">job_name</span>\
                                       <span class="o">+</span> <span class="s1">&#39; (conformer&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">job_name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
            <span class="n">content</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">content</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.save_restart_dict"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.save_restart_dict">[docs]</a>    <span class="k">def</span> <span class="nf">save_restart_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the restart_dict and save the restart.yml file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_restart</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Creating a restart file...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;running_jobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">spc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">spc</span><span class="o">.</span><span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">[</span><span class="s1">&#39;running_jobs&#39;</span><span class="p">][</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span>\
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="n">job_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]][</span><span class="n">job_name</span><span class="p">]</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                         <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">job_dict</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="s1">&#39;conformers&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">job_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;mer&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                           <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_jobs</span><span class="p">[</span><span class="n">spc</span><span class="o">.</span><span class="n">label</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;conformer&#39;</span> <span class="ow">in</span> <span class="n">job_name</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Dumping restart dictionary:</span><span class="se">\n</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">))</span>
            <span class="n">save_yaml_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_path</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scheduler.make_reaction_labels_info_file"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.make_reaction_labels_info_file">[docs]</a>    <span class="k">def</span> <span class="nf">make_reaction_labels_info_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A helper function for creating the `reactions labels.info` file&quot;&quot;&quot;</span>
        <span class="n">rxn_info_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;rxns&#39;</span><span class="p">,</span> <span class="s1">&#39;reaction labels.info&#39;</span><span class="p">)</span>
        <span class="n">old_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_directory</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;rxns&#39;</span><span class="p">,</span> <span class="s1">&#39;reaction labels.old.info&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">old_file_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_file_path</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">,</span> <span class="n">old_file_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">rxn_info_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;Reaction labels and respective TS labels:</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rxn_info_path</span></div>

<div class="viewcode-block" id="Scheduler.determine_adaptive_level"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.Scheduler.determine_adaptive_level">[docs]</a>    <span class="k">def</span> <span class="nf">determine_adaptive_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original_level_of_theory</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">heavy_atoms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the level of theory to be used according to the job type and number of heavy atoms.</span>
<span class="sd">        self.adaptive_levels is a dictionary of levels of theory for ranges of the number of heavy atoms in the</span>
<span class="sd">        molecule. Keys are tuples of (min_num_atoms, max_num_atoms), values are dictionaries with &#39;optfreq&#39; and &#39;sp&#39;</span>
<span class="sd">        as keys and levels of theory as values. &#39;inf&#39; is accepted an max_num_atoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">constraint</span><span class="p">,</span> <span class="n">level_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inf&#39;</span> <span class="ow">and</span> <span class="n">heavy_atoms</span> <span class="o">&gt;=</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">heavy_atoms</span> <span class="o">&gt;=</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s1">&#39;Could not determine adaptive level of theory for </span><span class="si">{0}</span><span class="s1"> heavy atoms using &#39;</span>
                                     <span class="s1">&#39;the following adaptive levels:</span><span class="se">\n</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">heavy_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">job_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;optfreq&#39;</span><span class="p">,</span> <span class="s1">&#39;composite&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s1">&#39;optfreq&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">level_dict</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s2">&quot;Could not find the &#39;optfreq&#39; key in the adaptive levels dictionary for &quot;</span>
                                         <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> heavy atoms. Got:</span><span class="se">\n</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">heavy_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">level_dict</span><span class="p">[</span><span class="s1">&#39;optfreq&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">job_type</span> <span class="o">==</span> <span class="s1">&#39;sp&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;sp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">level_dict</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SchedulerError</span><span class="p">(</span><span class="s2">&quot;Could not find the &#39;sp&#39; key in the adaptive levels dictionary for &quot;</span>
                                         <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> heavy atoms. Got:</span><span class="se">\n</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">heavy_atoms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adaptive_levels</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">level_dict</span><span class="p">[</span><span class="s1">&#39;sp&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># for any other job type use the original level of theory regardless of the number of atoms</span>
                <span class="k">return</span> <span class="n">original_level_of_theory</span></div></div>


<div class="viewcode-block" id="sum_time_delta"><a class="viewcode-back" href="../../api/scheduler.html#arc.scheduler.sum_time_delta">[docs]</a><span class="k">def</span> <span class="nf">sum_time_delta</span><span class="p">(</span><span class="n">timedelta_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A helper function for summing datetime.timedelta objects&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">timedelta</span> <span class="ow">in</span> <span class="n">timedelta_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">timedelta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">timedelta</span>
    <span class="k">return</span> <span class="n">result</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018-2019, Alon Grinberg Dana

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>